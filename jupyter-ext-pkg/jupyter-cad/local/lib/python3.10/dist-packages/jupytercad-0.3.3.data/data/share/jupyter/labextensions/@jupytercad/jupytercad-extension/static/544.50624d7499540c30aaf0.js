"use strict";(self.webpackChunk_jupytercad_jupytercad_extension=self.webpackChunk_jupytercad_jupytercad_extension||[]).push([[544],{7923:(e,t,n)=>{n.r(t),n.d(t,{default:()=>Ct});var s=n(4163),o=n(5350),i=n(926),a=n(4826),r=n(1140),d=n(2164),l=n(3262),c=n(2189),h=n(3781),p=n(6029),m=n(8778),u=n(398);function g(e,t,n="blue",s=6){e.save(),e.fillStyle=n,e.fillRect(t.x-s/2,t.y-s/2,s,s),e.restore()}function y(e){return p.createElement(c.Button,{className:"jp-Button jp-mod-minimal jp-ToolbarButtonComponent jp-mod-styled "+(e.toggled?"highlight":""),style:{color:"const(--jp-ui-font-color1)"},onClick:e.onClick},e.label.toUpperCase())}function v(e,t){return Math.sqrt((e.x-t.x)**2+(e.y-t.y)**2)}class b{constructor(e,t,n){this.start=e,this.end=t,this.controlPoints=n}export(e=1){return{start:{x:this.start.x/e,y:this.start.y/e},end:{x:this.end.x/e,y:this.end.y/e}}}}class f{constructor(e,t,n){this.option=n,this._x=e,this._y=t}get position(){return{x:this._x,y:this._y}}export(e=1){return{x:this._x/e,y:this._y/e}}}class _{constructor(e,t,n){this.center=e,this.radius=t,this.controlPoints=n}export(e=1){return{center:{x:this.center.x/e,y:this.center.y/e},radius:this.radius/e}}}class w{constructor(e){this._points=new Map,this._lines=new Map,this._circles=new Map([]),this._editing={type:null,content:null},this._gridSize=e.gridSize,this._sharedModel=e.sharedModel}get gridSize(){return this._gridSize}get points(){return this._points}get lines(){return this._lines}get circles(){return this._circles}get editing(){return this._editing}startEdit(e,t){this._editing.type=e,this._editing.content=t}updateEdit(e,t){e===this._editing.type&&(this.editing.content=t)}stopEdit(e){var t;if(e){const e=null===(t=this._editing.content)||void 0===t?void 0:t.tempId;if(e)switch(this._editing.type){case"CIRCLE":this.removeCircle(e);break;case"LINE":this.removeLine(e)}}this._editing.type=null,this._editing.content=null}addPoint(e,t){const n=this.getPointByPosition(e);if(n)return n;const s=(0,u.v4)();return this._points.set(s,new f(e.x,e.y,t)),s}removePoint(e){this._points.delete(e)}getPointByPosition(e){for(const[t,n]of this._points.entries())if(v(n.position,e)<.05*this._gridSize)return t}getPointById(e){return this._points.get(e)}addLine(e,t){const n=(0,u.v4)();return this._lines.set(n,new b(e,t)),n}removeLine(e){this._lines.delete(e)}getLineById(e){return this._lines.get(e)}getLineByControlPoint(e){const t=[];for(const[n,s]of this._lines.entries())s.controlPoints&&s.controlPoints.includes(e)&&t.push(n);return t}addCircle(e,t){const n=(0,u.v4)();return this._circles.set(n,new _(e,t)),n}removeCircle(e){this._circles.delete(e)}getCircleById(e){return this._circles.get(e)}getCircleByControlPoint(e){const t=[];for(const[n,s]of this._circles.entries())s.controlPoints&&s.controlPoints.includes(e)&&t.push(n);return t}async save(e,t){var n;if(this._sharedModel)if(this._sharedModel.objectExists(e))(0,o.showErrorMessage)("The object already exists","There is an existing object with the same name.");else{const s=[];this._circles.forEach((e=>{s.push(this._writeCircle(e.export(this._gridSize),t))})),this._lines.forEach((e=>{s.push(this._writeLine(e.export(this._gridSize),t))}));const o={shape:"Sketcher::SketchObject",name:e,visible:!0,parameters:{Geometry:s,Placement:{Position:[0,0,0],Axis:[0,0,1],Angle:0},AttachmentOffset:{Position:[0,0,0],Axis:[0,0,1],Angle:0}}};null===(n=this._sharedModel)||void 0===n||n.addObject(o)}}_writeLine(e,t){let n=0,s=0,o=0,i=0,a=0,r=0;return"XY"===t?(n=e.start.x,s=e.start.y,i=e.end.x,a=e.end.y):"YZ"===t?(s=e.start.x,o=e.start.y,a=e.end.x,r=e.end.y):(o=e.start.x,n=e.start.y,r=e.end.x,i=e.end.y),{TypeId:"Part::GeomLineSegment",StartX:n,StartY:s,StartZ:o,EndX:i,EndY:a,EndZ:r}}_writeCircle(e,t){let n,s,o,i=0,a=0,r=0;return"XY"===t?(n=e.center.x,s=e.center.y,o=0,r=1):"YZ"===t?(n=0,s=e.center.x,o=e.center.y,i=1):(n=e.center.y,s=0,o=e.center.x,a=1),{TypeId:"Part::GeomCircle",CenterX:n,CenterY:s,CenterZ:o,NormalX:i,NormalY:a,NormalZ:r,Radius:e.radius,AngleXU:0}}}var x=n(9993),C=n(4238),j=n(6258);const P='<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><g class="jp-icon3" fill="#616161"><g><path d="M2,6c0.55,0,1-0.45,1-1V4c0-0.55,0.45-1,1-1h1c0.55,0,1-0.45,1-1S5.55,1,5,1H4C2.34,1,1,2.34,1,4v1C1,5.55,1.45,6,2,6z"/><path d="M5,21H4c-0.55,0-1-0.45-1-1v-1c0-0.55-0.45-1-1-1c-0.55,0-1,0.45-1,1v1c0,1.66,1.34,3,3,3h1c0.55,0,1-0.45,1-1 S5.55,21,5,21z"/><path d="M20,1h-1c-0.55,0-1,0.45-1,1s0.45,1,1,1h1c0.55,0,1,0.45,1,1v1c0,0.55,0.45,1,1,1c0.55,0,1-0.45,1-1V4 C23,2.34,21.66,1,20,1z"/><path d="M22,18c-0.55,0-1,0.45-1,1v1c0,0.55-0.45,1-1,1h-1c-0.55,0-1,0.45-1,1s0.45,1,1,1h1c1.66,0,3-1.34,3-3v-1 C23,18.45,22.55,18,22,18z"/><path d="M19,14.87V9.13c0-0.72-0.38-1.38-1-1.73l-5-2.88c-0.31-0.18-0.65-0.27-1-0.27s-0.69,0.09-1,0.27L6,7.39 C5.38,7.75,5,8.41,5,9.13v5.74c0,0.72,0.38,1.38,1,1.73l5,2.88c0.31,0.18,0.65,0.27,1,0.27s0.69-0.09,1-0.27l5-2.88 C18.62,16.25,19,15.59,19,14.87z M11,17.17l-4-2.3v-4.63l4,2.33V17.17z M12,10.84L8.04,8.53L12,6.25l3.96,2.28L12,10.84z M17,14.87l-4,2.3v-4.6l4-2.33V14.87z"/></g></g></svg>\n',S=new c.LabIcon({name:"jupytercad:control-light",svgstr:P}),M=new c.LabIcon({name:"jupytercad:minimize-icon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" height="20" width="20"><path class="jp-icon3" fill="#616161" d="M5 11.75v-1.5h10v1.5Z"/></svg>\n'}),A=new c.LabIcon({name:"jupytercad:box-icon",svgstr:'<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   width="14.3"\n   viewBox="0 0 21.45 14.3"\n   version="1.1"\n   height="14.3"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:svg="http://www.w3.org/2000/svg">\n  <g\n     class="jp-icon3"\n     fill="#616161"\n     transform="translate(0.75039085,0.49939006)">\n    <path\n       d="M 0.97460938,-0.32421875 A 0.97509752,0.97509752 0 0 0 0,0.65039062 V 15.650391 A 0.97509752,0.97509752 0 0 0 0.97460938,16.625 H 15.974609 a 0.97509752,0.97509752 0 0 0 0.97461,-0.974609 V 0.65039062 a 0.97509752,0.97509752 0 0 0 -0.97461,-0.97460937 z M 1.9492187,1.625 H 15 V 14.675781 H 1.9492187 Z"\n       />\n    <path\n       d="M 3.9746094,-3.3242188 A 0.97500002,0.97500002 0 0 0 3,-2.3496094 0.97500002,0.97500002 0 0 0 3.9746094,-1.375 H 18 v 13.621094 l -2.714844,2.714844 a 0.97500002,0.97500002 0 0 0 0,1.378906 0.97500002,0.97500002 0 0 0 1.378906,0 l 3,-3 a 0.97509752,0.97509752 0 0 0 0.285157,-0.689453 V -2.3496094 a 0.97509752,0.97509752 0 0 0 -0.97461,-0.9746094 z"\n       />\n    <path\n       d="m 18.974609,-3.3242188 a 0.97500002,0.97500002 0 0 0 -0.689453,0.2851563 l -3,3 a 0.97500002,0.97500002 0 0 0 0,1.3789062 0.97500002,0.97500002 0 0 0 1.378906,0 l 3,-2.9999999 a 0.97500002,0.97500002 0 0 0 0,-1.3789063 0.97500002,0.97500002 0 0 0 -0.689453,-0.2851563 z"\n       />\n    <path\n       d="m 3.9746094,-3.3242188 a 0.97500002,0.97500002 0 0 0 -0.6894531,0.2851563 l -3.00000005,3 a 0.97500002,0.97500002 0 0 0 0,1.3789062 0.97500002,0.97500002 0 0 0 1.37890625,0 l 3,-2.9999999 a 0.97500002,0.97500002 0 0 0 0,-1.3789063 0.97500002,0.97500002 0 0 0 -0.6894531,-0.2851563 z"\n       />\n    <path\n       d="M 3.9746094,-1.2421875 A 0.97500002,0.97500002 0 0 0 3,-0.26757813 V 1.6835937 A 0.97500002,0.97500002 0 0 0 3.9746094,2.6582031 0.97500002,0.97500002 0 0 0 4.9492187,1.6835937 V -0.26757813 A 0.97500002,0.97500002 0 0 0 3.9746094,-1.2421875 Z m 0,5.8496094 A 0.97500002,0.97500002 0 0 0 3,5.5820312 V 7.5332031 A 0.97500002,0.97500002 0 0 0 3.9746094,8.5078125 0.97500002,0.97500002 0 0 0 4.9492187,7.5332031 V 5.5820312 A 0.97500002,0.97500002 0 0 0 3.9746094,4.6074219 Z m 0,5.8496091 A 0.97500002,0.97500002 0 0 0 3,11.433594 v 0.8125 l -0.2324219,0.232422 a 0.97500002,0.97500002 0 0 0 0,1.378906 0.97500002,0.97500002 0 0 0 1.3789063,0 L 4.6640625,13.339844 A 0.97509752,0.97509752 0 0 0 4.9492187,12.650391 V 11.433594 A 0.97500002,0.97500002 0 0 0 3.9746094,10.457031 Z"\n       />\n    <path\n       d="M 3.9746094,11.675781 A 0.97500002,0.97500002 0 0 0 3,12.650391 0.97500002,0.97500002 0 0 0 3.9746094,13.625 h 0.9746093 a 0.97500002,0.97500002 0 0 0 0.9765625,-0.974609 0.97500002,0.97500002 0 0 0 -0.9765625,-0.97461 z m 4.875,0 A 0.97500002,0.97500002 0 0 0 7.875,12.650391 0.97500002,0.97500002 0 0 0 8.8496094,13.625 h 1.9511716 a 0.97500002,0.97500002 0 0 0 0.97461,-0.974609 0.97500002,0.97500002 0 0 0 -0.97461,-0.97461 z m 5.8496096,0 a 0.97500002,0.97500002 0 0 0 -0.97461,0.97461 0.97500002,0.97500002 0 0 0 0.97461,0.974609 h 1.951172 A 0.97500002,0.97500002 0 0 0 17.625,12.650391 0.97500002,0.97500002 0 0 0 16.650391,11.675781 Z"\n       />\n  </g>\n</svg>\n'}),O=new c.LabIcon({name:"jupytercad:cone-icon",svgstr:'<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   width="12.3"\n   viewBox="0 0 18.45 13.3"\n   version="1.1"\n   height="13.3"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:svg="http://www.w3.org/2000/svg">\n  <g\n     class="jp-icon3"\n     fill="#616161"\n      transform="translate(0.75038755,0.49961028)">\n    <path\n       d="M 8.4746094,-3.0742188 A 0.97509752,0.97509752 0 0 0 7.6035156,-2.5371094 L 0.10351562,12.462891 A 0.97509752,0.97509752 0 0 0 0,12.900391 c 0,0 0.01804825,0.240769 0.07226562,0.392578 C 0.126483,13.444777 0.21694,13.605641 0.34375,13.757813 0.59736999,14.062156 0.9779784,14.325566 1.5507812,14.554688 2.696387,15.01293 4.6596132,15.375 8.4746094,15.375 c 3.8149966,0 5.7801756,-0.36207 6.9257816,-0.820312 0.572802,-0.229122 0.953411,-0.492532 1.207031,-0.796875 0.12681,-0.152172 0.217267,-0.313036 0.271484,-0.464844 0.05422,-0.151809 0.07031,-0.392578 0.07031,-0.392578 a 0.97509752,0.97509752 0 0 0 -0.101563,-0.4375 L 9.3476563,-2.5371094 A 0.97509752,0.97509752 0 0 0 8.4746094,-3.0742188 Z M 8.4765625,0.08007812 14.779297,12.6875 c -0.05791,0.02963 -0.01621,0.02172 -0.103516,0.05664 -0.729392,0.291757 -2.516175,0.68164 -6.2011716,0.68164 -3.6849963,0 -5.4698264,-0.389883 -6.1992188,-0.68164 C 2.1880816,12.70922 2.2297876,12.71713 2.171875,12.6875 Z"\n       />\n    <path\n       d="M 10.378906,10.460938 A 0.97500002,0.97500002 0 0 0 9.3710938,11.402344 0.97500002,0.97500002 0 0 0 10.3125,12.410156 l 0.03906,0.002 0.542968,0.02539 0.503907,0.0332 0.464843,0.03906 0.328125,0.0332 a 0.97500002,0.97500002 0 0 0 1.06836,-0.871094 0.97500002,0.97500002 0 0 0 -0.871094,-1.068359 l -0.337891,-0.03516 a 0.97509752,0.97509752 0 0 0 -0.01758,-0.002 l -0.482422,-0.03906 a 0.97509752,0.97509752 0 0 0 -0.01758,-0.002 l -0.519531,-0.0332 a 0.97509752,0.97509752 0 0 0 -0.01563,-0.002 l -0.556641,-0.02734 a 0.97509752,0.97509752 0 0 0 -0.01563,0 z m -3.9804685,0.0078 -0.4472656,0.02148 a 0.97509752,0.97509752 0 0 0 -0.015625,0.002 l -0.5195313,0.0332 a 0.97509752,0.97509752 0 0 0 -0.015625,0.002 l -0.4824219,0.03906 a 0.97509752,0.97509752 0 0 0 -0.019531,0.002 l -0.4453125,0.04492 a 0.97509752,0.97509752 0 0 0 -0.019531,0.002 l -0.050781,0.0059 a 0.97500002,0.97500002 0 0 0 -0.8476562,1.08789 0.97500002,0.97500002 0 0 0 1.0859374,0.84961 l 0.039063,-0.0059 0.4277344,-0.04297 0.4648438,-0.03906 0.5019531,-0.0332 0.4394531,-0.02148 A 0.97500002,0.97500002 0 0 0 7.4199219,11.394531 0.97500002,0.97500002 0 0 0 6.3984375,10.46875 Z m 8.9960935,1.460938 a 0.97500002,0.97500002 0 0 0 -0.28125,1.273437 0.97500002,0.97500002 0 0 0 0.966797,0.666016 0.97500002,0.97500002 0 0 0 0.863281,-1.074219 v -0.01758 a 0.97509752,0.97509752 0 0 0 -0.01758,-0.09961 l -0.0039,-0.01953 a 0.97509752,0.97509752 0 0 0 -0.02148,-0.08398 l -0.0078,-0.02734 a 0.97509752,0.97509752 0 0 0 -0.03125,-0.08203 l -0.01367,-0.0332 a 0.97509752,0.97509752 0 0 0 -0.03711,-0.08008 l -0.01953,-0.04102 a 0.97509752,0.97509752 0 0 0 -0.04297,-0.07422 l -0.0059,-0.0098 a 0.97500002,0.97500002 0 0 0 -1.347656,-0.296875 z"\n       />\n  </g>\n</svg>\n'}),E=new c.LabIcon({name:"jupytercad:sphere-icon",svgstr:'<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   width="12.3"\n   viewBox="0 0 18.45 12.3"\n   version="1.1"\n   height="12.3"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:svg="http://www.w3.org/2000/svg">\n  <g\n     class="jp-icon3"\n     fill="#616161"\n     transform="translate(0.7503905,0.4996094)">\n    <path\n       d="M 8.4746094,-2.8242188 C 3.8055493,-2.8242188 0,0.98133055 0,5.6503906 0,10.319451 3.8055493,14.125 8.4746094,14.125 c 4.6690596,0 8.4746096,-3.805549 8.4746096,-8.4746094 0,-4.66906005 -3.80555,-8.4746094 -8.4746096,-8.4746094 z m 0,1.9492188 C 12.089812,-0.875 15,2.0351877 15,5.6503906 15,9.2655935 12.089812,12.175781 8.4746094,12.175781 4.8594065,12.175781 1.9492187,9.2655935 1.9492187,5.6503906 1.9492188,2.0351877 4.8594065,-0.875 8.4746094,-0.875 Z"\n       />\n  </g>\n</svg>\n'}),T=new c.LabIcon({name:"jupytercad:cylinder-icon",svgstr:'<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   width="12.299"\n   viewBox="0 0 18.448499 14.299001"\n   version="1.1"\n   height="14.299"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:svg="http://www.w3.org/2000/svg">\n  <g\n     class="jp-icon3"\n     fill="#616161"\n     transform="translate(0.7496415,0.4991099)">\n    <path\n       d="M 10.378906,11.710938 A 0.97500002,0.97500002 0 0 0 9.3710938,12.652344 0.97500002,0.97500002 0 0 0 10.3125,13.660156 l 0.03906,0.002 0.542968,0.02539 0.503907,0.0332 0.464843,0.03906 0.328125,0.0332 a 0.97500002,0.97500002 0 0 0 1.06836,-0.871094 0.97500002,0.97500002 0 0 0 -0.871094,-1.068359 l -0.337891,-0.03516 a 0.97509752,0.97509752 0 0 0 -0.01758,-0.002 l -0.482422,-0.03906 a 0.97509752,0.97509752 0 0 0 -0.01758,-0.002 l -0.519531,-0.0332 a 0.97509752,0.97509752 0 0 0 -0.01563,-0.002 l -0.556641,-0.02734 a 0.97509752,0.97509752 0 0 0 -0.01563,0 z m -3.9804685,0.0078 -0.4472656,0.02148 a 0.97509752,0.97509752 0 0 0 -0.015625,0.002 l -0.5195313,0.0332 a 0.97509752,0.97509752 0 0 0 -0.015625,0.002 l -0.4824219,0.03906 a 0.97509752,0.97509752 0 0 0 -0.019531,0.002 l -0.4453125,0.04492 a 0.97509752,0.97509752 0 0 0 -0.019531,0.002 l -0.050781,0.0078 a 0.97500002,0.97500002 0 0 0 -0.8476562,1.085937 0.97500002,0.97500002 0 0 0 1.0859374,0.84961 l 0.039063,-0.0059 0.4277344,-0.04297 0.4648438,-0.03906 0.5019531,-0.0332 0.4394531,-0.02148 A 0.97500002,0.97500002 0 0 0 7.4199219,12.644531 0.97500002,0.97500002 0 0 0 6.3984375,11.71875 Z m 8.9960935,1.462891 a 0.97500002,0.97500002 0 0 0 -0.28125,1.271484 0.97500002,0.97500002 0 0 0 0.966797,0.666016 0.97500002,0.97500002 0 0 0 0.863281,-1.074219 v -0.01758 a 0.97509752,0.97509752 0 0 0 -0.01758,-0.09961 l -0.0039,-0.01953 a 0.97509752,0.97509752 0 0 0 -0.02148,-0.08398 l -0.0078,-0.02734 a 0.97509752,0.97509752 0 0 0 -0.03125,-0.08203 l -0.01367,-0.0332 a 0.97509752,0.97509752 0 0 0 -0.03711,-0.08008 l -0.01953,-0.04102 a 0.97509752,0.97509752 0 0 0 -0.04297,-0.07422 l -0.0059,-0.0098 a 0.97500002,0.97500002 0 0 0 -1.347656,-0.294922 z"\n       />\n    <path\n       d="m 8.4746094,-3.3242188 c -3.8149962,0 -5.7782224,0.3601171 -6.9238282,0.8183594 -0.5728028,0.2291212 -0.95341121,0.492531 -1.2070312,0.796875 -0.12680999,0.152172 -0.21726701,0.3149883 -0.27148438,0.4667969 C 0.01804826,-1.0903789 0,-0.84960938 0,-0.84960938 V 14.150391 c 0,0 0.01804825,0.240769 0.07226562,0.392578 C 0.126483,14.694777 0.21694,14.855641 0.34375,15.007813 0.59736999,15.312156 0.9779784,15.575566 1.5507812,15.804688 2.696387,16.26293 4.6596132,16.625 8.4746094,16.625 c 3.8149966,0 5.7801756,-0.36207 6.9257816,-0.820312 0.572802,-0.229122 0.953411,-0.492532 1.207031,-0.796875 0.12681,-0.152172 0.217267,-0.313036 0.271484,-0.464844 0.05422,-0.151809 0.07031,-0.392578 0.07031,-0.392578 V -0.84960938 c 0,0 -0.01609,-0.24076952 -0.07031,-0.39257812 -0.05422,-0.1518086 -0.144674,-0.3146249 -0.271484,-0.4667969 -0.25362,-0.304344 -0.634229,-0.5677538 -1.207031,-0.796875 -1.145606,-0.4582423 -3.110785,-0.8183594 -6.9257816,-0.8183594 z m 0,1.9492188 c 3.0471916,0 4.5852506,0.2665045 5.5117186,0.5234375 -0.926377,0.25696341 -2.464139,0.52734375 -5.5117186,0.52734375 -3.0487048,0 -4.5856075,-0.27029195 -5.5117188,-0.52734375 C 3.8890936,-1.1085838 5.426293,-1.375 8.4746094,-1.375 Z M 1.9492187,0.8984375 C 3.1300711,1.3036077 4.9683623,1.625 8.4746094,1.625 11.979656,1.625 13.81903,1.3034006 15,0.8984375 V 13.818359 c -0.03402,0.02875 -0.05133,0.06663 -0.324219,0.175782 -0.729392,0.291757 -2.516175,0.68164 -6.2011716,0.68164 -3.6849963,0 -5.4698264,-0.389883 -6.1992188,-0.68164 C 2.0012328,13.884477 1.9826178,13.846664 1.9492187,13.818359 Z"\n       />\n  </g>\n</svg>\n'}),I=new c.LabIcon({name:"jupytercad:torus-icon",svgstr:'<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   width="12.424"\n   viewBox="0 0 18.636 9.3000002"\n   version="1.1"\n   height="9.3000002"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:svg="http://www.w3.org/2000/svg">\n  <g\n     class="jp-icon3"\n     fill="#616161"\n     transform="translate(0.75013988,0.4996095)">\n    <path\n       d="M 1.0683594,3.9257813 A 0.97500002,0.97500002 0 0 0 0.09375,4.9003906 c 0,0 0.0199614,1.5024693 1.1621094,2.8730469 1.1421479,1.3705776 3.3675039,2.6015625 7.3125,2.6015625 3.9449956,0 6.1683986,-1.2309849 7.3105466,-2.6015625 1.142148,-1.3705776 1.164063,-2.8730469 1.164063,-2.8730469 A 0.97500002,0.97500002 0 0 0 16.068359,3.9257813 0.97500002,0.97500002 0 0 0 15.09375,4.9003906 c 0,0 0.01996,0.7455798 -0.712891,1.625 -0.73285,0.8794202 -2.257503,1.9003907 -5.8124996,1.9003907 -3.5549965,0 -5.081603,-1.0209705 -5.8144531,-1.9003907 -0.7328502,-0.8794202 -0.7109375,-1.625 -0.7109375,-1.625 A 0.97500002,0.97500002 0 0 0 1.0683594,3.9257813 Z"\n       />\n    <path\n       d="M 4.0683594,3.9257813 A 0.97500002,0.97500002 0 0 0 3.09375,4.9003906 c 0,0 0.024046,0.3742631 0.171875,0.6699219 0.1478294,0.2956588 0.4181616,0.6199202 0.8242187,0.890625 C 4.901958,7.002347 6.2100284,7.375 8.5683594,7.375 10.92669,7.375 12.234761,7.002347 13.046875,6.4609375 13.452932,6.1902327 13.721311,5.8659712 13.869141,5.5703125 14.01697,5.2746538 14.042969,4.9003906 14.042969,4.9003906 A 0.97500002,0.97500002 0 0 0 13.068359,3.9257813 0.97500002,0.97500002 0 0 0 12.09375,4.9003906 c 0,0 0.02404,-0.1867628 0.03125,-0.2011719 0.0072,-0.014409 -0.0037,0.034377 -0.160156,0.1386719 -0.312885,0.2085897 -1.25482,0.5878907 -3.3964846,0.5878906 -2.1416645,0 -3.0835998,-0.3793008 -3.3964844,-0.5878906 C 5.0154327,4.7335958 5.0025611,4.6848097 5.0097656,4.6992187 c 0.0072,0.014409 0.033203,0.2011719 0.033203,0.2011719 A 0.97500002,0.97500002 0 0 0 4.0683594,3.9257813 Z"\n       />\n    <path\n       d="m 8.5683594,-2.0742188 c -4.716662,0 -7.0736345,1.69023778 -7.9980469,3.5390625 -0.92441237,1.8488248 -0.44726562,3.671875 -0.44726563,3.671875 A 0.97500002,0.97500002 0 0 0 1.3046875,5.8457031 0.97500002,0.97500002 0 0 0 2.0136719,4.6640625 c 0,0 -0.2748049,-1.1769528 0.3007812,-2.328125 C 2.8900392,1.1847653 4.2850303,-0.125 8.5683594,-0.125 c 4.2833286,0 5.6763666,1.3097653 6.2519536,2.4609375 0.575586,1.1511722 0.302734,2.328125 0.302734,2.328125 a 0.97500002,0.97500002 0 0 0 0.708984,1.1816406 0.97500002,0.97500002 0 0 0 1.181641,-0.7089844 c 0,0 0.475193,-1.8230502 -0.449219,-3.671875 -0.924412,-1.84882471 -3.279432,-3.5390624 -7.9960936,-3.5390625 z"\n       />\n    <path\n       d="m 8.5683594,0.92578125 c -1.5812484,0 -2.7260935,0.18926555 -3.5957032,0.53710935 -0.8696096,0.3478439 -1.4735685,0.8944027 -1.7773437,1.5019532 -0.6075505,1.2151009 0,2.3710937 0,2.3710937 A 0.97500002,0.97500002 0 0 0 4.5039062,5.7714844 0.97500002,0.97500002 0 0 0 4.9394531,4.4648437 c 0,0 -0.1424488,-0.3440086 0,-0.6289062 0.071224,-0.1424488 0.2192204,-0.3478444 0.7558594,-0.5625 C 6.2319515,3.0587819 7.1496108,2.875 8.5683594,2.875 c 1.4187484,0 2.3364076,0.1837819 2.8730466,0.3984375 0.536639,0.2146556 0.682682,0.4200512 0.753907,0.5625 0.142448,0.2848976 -1e-6,0.6289062 0,0.6289062 a 0.97500002,0.97500002 0 0 0 0.4375,1.3066407 0.97500002,0.97500002 0 0 0 1.30664,-0.4355469 c 0,0 0.607551,-1.1559928 0,-2.3710937 C 13.635678,2.3572933 13.033672,1.8107345 12.164063,1.4628906 11.294453,1.1150468 10.149608,0.92578125 8.5683594,0.92578125 Z"\n       />\n  </g>\n</svg>\n'}),L=new c.LabIcon({name:"jupytercad:cut-icon",svgstr:'<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   width="12.8"\n   viewBox="0 0 19.2 12.3"\n   version="1.1"\n   height="12.3"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:svg="http://www.w3.org/2000/svg">\n  <g\n     class="jp-icon3"\n     fill="#616161"\n     transform="translate(0.7503905,0.49960916)">\n    <path\n       d="m 6.225,2.6499939 a 5.25,5.25 0 0 0 -5.24999998,5.25 A 5.25,5.25 0 0 0 6.225,13.149994 5.25,5.25 0 0 0 11.410547,8.6441339 5.25,5.25 0 0 1 6.225,3.3999939 5.25,5.25 0 0 1 6.2894531,2.6529239 5.25,5.25 0 0 0 6.225,2.6499939 Z"\n       />\n    <path\n       d="M 6.2246094,1.6757812 C 2.7981888,1.6757813 0,4.47397 0,7.9003906 -6.5265155e-8,11.326811 2.7981887,14.125 6.2246094,14.125 a 0.97509752,0.97509752 0 0 0 0.00195,0 C 9.3113218,14.118272 11.93777,11.836826 12.375,8.7832031 A 0.97509752,0.97509752 0 0 0 11.421875,7.6699219 C 9.0734969,7.6410905 7.2037815,5.7503771 7.1992187,3.4023438 7.2026815,3.2024961 7.2205938,3.0040526 7.2519531,2.8066406 A 0.97509752,0.97509752 0 0 0 6.3398437,1.6796875 c -0.025467,-0.00131 -0.050691,-0.0029 -0.076172,-0.00391 a 0.97509752,0.97509752 0 0 0 -0.039063,0 z M 5.3320312,3.8046875 c 0.191742,2.767078 2.184134,4.9590576 4.8300778,5.5507813 -0.6065615,1.6468932 -2.1170701,2.8155162 -3.9374996,2.8203122 -2.3725635,0 -4.2753907,-1.902827 -4.2753907,-4.2753904 0,-2.0550907 1.4589167,-3.6769146 3.3828125,-4.0957031 z"\n       />\n    <path\n       d="M 11.474609,-2.8242188 C 8.0481887,-2.8242188 5.25,-0.02603001 5.25,3.4003906 5.25,6.8268113 8.0481887,9.625 11.474609,9.625 c 3.426421,0 6.22461,-2.7981887 6.22461,-6.2246094 0,-3.42642061 -2.798189,-6.2246094 -6.22461,-6.2246094 z m 0,1.9492188 c 2.372564,0 4.275391,1.9028272 4.275391,4.2753906 0,2.3725635 -1.902827,4.2753906 -4.275391,4.2753906 -2.3725631,0 -4.2753902,-1.9028271 -4.2753903,-4.2753906 0,-2.3725634 1.9028272,-4.2753906 4.2753903,-4.2753906 z"\n       />\n  </g>\n</svg>\n'}),N=new c.LabIcon({name:"jupytercad:union-icon",svgstr:'<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   width="12.8"\n   viewBox="0 0 19.2 12.3"\n   version="1.1"\n   height="12.3"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:svg="http://www.w3.org/2000/svg">\n  <g\n     class="jp-icon3"\n     fill="#616161"\n     transform="translate(0.7503905,0.49960916)">\n    <path\n       d="m 6.225,2.6499939 a 5.25,5.25 0 0 0 -5.24999998,5.25 A 5.25,5.25 0 0 0 6.225,13.149994 5.25,5.25 0 0 0 11.410547,8.6441339 5.25,5.25 0 0 1 6.225,3.3999939 5.25,5.25 0 0 1 6.2894531,2.6529239 5.25,5.25 0 0 0 6.225,2.6499939 Z"\n       />\n    <path\n       d="M 6.2246094,1.6757812 C 2.7981888,1.6757813 0,4.47397 0,7.9003906 -6.5265155e-8,11.326811 2.7981887,14.125 6.2246094,14.125 a 0.97509752,0.97509752 0 0 0 0.00195,0 C 9.3113218,14.118272 11.93777,11.836826 12.375,8.7832031 A 0.97509752,0.97509752 0 0 0 11.421875,7.6699219 C 9.0734969,7.6410905 7.2037815,5.7503771 7.1992187,3.4023438 7.2026815,3.2024961 7.2205938,3.0040526 7.2519531,2.8066406 A 0.97509752,0.97509752 0 0 0 6.3398437,1.6796875 c -0.025467,-0.00131 -0.050691,-0.0029 -0.076172,-0.00391 a 0.97509752,0.97509752 0 0 0 -0.039063,0 z M 5.3320312,3.8046875 c 0.191742,2.767078 2.184134,4.9590576 4.8300778,5.5507813 -0.6065615,1.6468932 -2.1170701,2.8155162 -3.9374996,2.8203122 -2.3725635,0 -4.2753907,-1.902827 -4.2753907,-4.2753904 0,-2.0550907 1.4589167,-3.6769146 3.3828125,-4.0957031 z"\n       />\n    <path\n       d="m 16.725,3.4000001 a 5.25,5.25 0 0 1 -5.25,5.25 5.25,5.25 0 0 1 -5.2499996,-5.25 5.25,5.25 0 0 1 5.2499996,-5.25 5.25,5.25 0 0 1 5.25,5.25 z"\n       />\n    <path\n       d="M 11.474609,-2.8242188 C 8.0481887,-2.8242188 5.25,-0.02603001 5.25,3.4003906 5.25,6.8268113 8.0481887,9.625 11.474609,9.625 c 3.426421,0 6.22461,-2.7981887 6.22461,-6.2246094 0,-3.42642061 -2.798189,-6.2246094 -6.22461,-6.2246094 z m 0,1.9492188 c 2.372564,0 4.275391,1.9028272 4.275391,4.2753906 0,2.3725635 -1.902827,4.2753906 -4.275391,4.2753906 -2.3725631,0 -4.2753902,-1.9028271 -4.2753903,-4.2753906 0,-2.3725634 1.9028272,-4.2753906 4.2753903,-4.2753906 z"\n       />\n  </g>\n</svg>\n'}),k=new c.LabIcon({name:"jupytercad:intersection-icon",svgstr:'<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   width="11.8"\n   viewBox="0 0 17.7 11.8"\n   version="1.1"\n   height="11.8"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:svg="http://www.w3.org/2000/svg">\n  <g\n     class="jp-icon3"\n     fill="#616161"\n     transform="translate(0.7503905,0.4996094)">\n    <path\n       d="m 5.4750003,2.7749937 a 5.25,5.25 0 0 0 5.2499997,5.25 5.25,5.25 0 0 0 -5.2499997,-5.25 z"\n       />\n    <path\n       d="M 5.4746094,1.8007812 A 0.97509752,0.97509752 0 0 0 4.5,2.7753906 C 4.5,6.2018111 7.2981889,8.9999998 10.724609,9 a 0.97509752,0.97509752 0 0 0 0.97461,-0.9746094 c 0,-3.4264205 -2.7981891,-6.2246092 -6.2246096,-6.2246094 z M 6.6953125,3.9941406 C 8.061332,4.4049806 9.0950195,5.4386679 9.5058594,6.8046875 8.1395235,6.3938951 7.1061048,5.3604766 6.6953125,3.9941406 Z"\n       />\n    <path\n       d="M 6.2246094,1.0507812 C 2.7981887,1.0507812 0,3.84897 0,7.2753906 0,10.701811 2.7981887,13.5 6.2246094,13.5 9.65103,13.5 12.449219,10.701811 12.449219,7.2753906 12.449219,3.84897 9.65103,1.0507813 6.2246094,1.0507812 Z M 6.2246094,3 C 8.5971728,3 10.5,4.9028272 10.5,7.2753906 10.5,9.6479541 8.5971728,11.550781 6.2246094,11.550781 3.8520459,11.550781 1.9492187,9.6479541 1.9492187,7.2753906 1.9492188,4.9028272 3.8520459,3 6.2246094,3 Z"\n       />\n    <path\n       d="M 9.9746094,-2.6992188 C 6.5481887,-2.6992188 3.75,0.09896999 3.75,3.5253906 3.75,6.9518113 6.5481887,9.75 9.9746094,9.75 c 3.4264206,0 6.2246096,-2.7981887 6.2246096,-6.2246094 0,-3.42642061 -2.798189,-6.2246094 -6.2246096,-6.2246094 z m 0,1.9492188 C 12.347173,-0.75 14.25,1.1528272 14.25,3.5253906 c 0,2.3725635 -1.902827,4.2753906 -4.2753906,4.2753906 -2.3725635,0 -4.2753907,-1.9028271 -4.2753907,-4.2753906 C 5.6992187,1.1528272 7.6020459,-0.75 9.9746094,-0.75 Z"\n       />\n  </g>\n</svg>\n'}),B=new c.LabIcon({name:"jupytercad:extrusion-icon",svgstr:'<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   width="14.3"\n   viewBox="0 0 21.45 14.3"\n   version="1.1"\n   height="14.3"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:svg="http://www.w3.org/2000/svg">\n  <g\n     class="jp-icon3"\n     fill="#616161">\n   <path\n      d="m 6.9746094,6.5996094 a 0.97509752,0.97509752 0 0 0 -0.7792969,0.390625 l -4.5,5.9999996 a 0.97500002,0.97500002 0 0 0 0.011719,0.08399 0.97500002,0.97500002 0 0 0 -0.2070312,0.5 0.97500002,0.97500002 0 0 0 0.3828125,0.730469 0.97500002,0.97500002 0 0 0 0.00781,0.05078 0.97500002,0.97500002 0 0 0 0.3007813,0.07617 0.97500002,0.97500002 0 0 0 0.2832031,0.11914 H 15.974609 a 0.97509752,0.97509752 0 0 0 0.873047,-0.539062 l 3,-6.0000002 A 0.97509752,0.97509752 0 0 0 18.974609,6.5996094 Z m 0.4882812,1.9511719 h 9.9355464 l -2.02539,4.0488277 H 4.4257812 Z"\n      />\n   <path\n      d="M 11.474609,-2.4003906 A 0.97500002,0.97500002 0 0 0 10.5,-1.4257812 V 10.574219 a 0.97500002,0.97500002 0 0 0 0.974609,0.976562 0.97500002,0.97500002 0 0 0 0.97461,-0.976562 V -1.4257812 a 0.97500002,0.97500002 0 0 0 -0.97461,-0.9746094 z"\n      />\n   <path\n      d="m 10.785156,-2.1152344 -1.4999997,1.50000003 a 0.97500002,0.97500002 0 0 0 0,1.37890624 0.97500002,0.97500002 0 0 0 1.3789067,0 l 0.810546,-0.81054687 0.810547,0.81054687 a 0.97500002,0.97500002 0 0 0 1.378907,0 0.97500002,0.97500002 0 0 0 0,-1.37890624 l -1.5,-1.50000003 a 0.97509752,0.97509752 0 0 0 -1.378907,0 z"\n      />\n   </g>\n</svg>\n'}),D=new c.LabIcon({name:"jupytercad:axes-icon",svgstr:'<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg width="14.3" viewBox="0 0 21.45 14.3" version="1.1" height="14.3" xmlns="http://www.w3.org/2000/svg"\n   xmlns:svg="http://www.w3.org/2000/svg">\n   <g class="jp-icon3" fill="#616161">\n      <path\n         d="m 10.785156,8.0390625 a 0.97509752,0.97509752 0 0 0 -0.40039,0.083984 L 3.5761719,11.185547 A 0.97500002,0.97500002 0 0 0 3.0859375,12.474609 0.97500002,0.97500002 0 0 0 4.375,12.964844 l 6.619141,-2.9765627 h 8.791015 a 0.97500002,0.97500002 0 0 0 0.97461,-0.9746094 0.97500002,0.97500002 0 0 0 -0.97461,-0.9746094 z" />\n      <path\n         d="M 10.785156,-0.9609375 A 0.97500002,0.97500002 0 0 0 9.8105469,0.01367188 V 9.0136719 a 0.97500002,0.97500002 0 0 0 0.9746091,0.9746094 0.97500002,0.97500002 0 0 0 0.97461,-0.9746094 V 0.01367188 a 0.97500002,0.97500002 0 0 0 -0.97461,-0.97460938 z" />\n      <path\n         d="m 10.095703,-0.67578125 -1.4999999,1.5 a 0.97500002,0.97500002 0 0 0 0,1.37890625 0.97500002,0.97500002 0 0 0 1.3789063,0 L 10.785156,1.3925781 11.595703,2.203125 a 0.97500002,0.97500002 0 0 0 1.378906,0 0.97500002,0.97500002 0 0 0 0,-1.37890625 l -1.5,-1.5 a 0.97509752,0.97509752 0 0 0 -1.378906,0 z" />\n      <path\n         d="m 3.0019531,10.109375 a 0.97500002,0.97500002 0 0 0 -1.1933594,0.689453 l -0.5507812,2.048828 a 0.97509752,0.97509752 0 0 0 0.6894531,1.19336 l 2.0507813,0.548828 A 0.97500002,0.97500002 0 0 0 5.1914062,13.900391 0.97500002,0.97500002 0 0 0 4.5019531,12.707031 L 3.3945313,12.410156 3.6914063,11.302734 A 0.97500002,0.97500002 0 0 0 3.0019531,10.109375 Z " />\n  <path\n     d=" m 17.595703,6.8242187 a 0.97500002,0.97500002 0 0 0 0,1.3789063 l 0.810547,0.8105469 -0.810547,0.8105469 a\n         0.97500002,0.97500002 0 0 0 0,1.3789062 0.97500002,0.97500002 0 0 0 1.378906,0 l 1.5,-1.5 a\n         0.97509752,0.97509752 0 0 0 0,-1.3789062 l -1.5,-1.5000001 a 0.97500002,0.97500002 0 0 0 -1.378906,0 z" />\n   </g>\n</svg>\n'}),F=new c.LabIcon({name:"jupytercad:explodedView-icon",svgstr:P});function R(e,t=100){let n,s;return function(...o){const i=+new Date;n&&i<n+t?(clearTimeout(s),s=setTimeout((()=>{n=i,e(...o)}),t)):(n=i,e(...o))}}function z(e,t){for(const n of t)if(n.name===e)return n}function W(e,t,n,s,o){var i;const a=["border-color","box-shadow"];let r;if(t){if(t!==o){G(e,o,a);const n=V(e,t);n&&(n.style.borderColor=null!=s?s:"red",n.style.boxShadow=`inset 0 0 4px ${null!=s?s:"red"}`),r=t}}else if(o){if(G(e,o,a),n){const t=V(e,o);"input"===(null===(i=null==t?void 0:t.tagName)||void 0===i?void 0:i.toLowerCase())&&(t.value=n)}r=void 0}return r}function V(e,t){if(!e||!t)return;const n=document.querySelector(`[data-path="${e}"]`);return n?n.querySelector(`[id$=${t}]`):void 0}function G(e,t,n){if(!e||!t||0===n.length)return;const s=V(e,t);s&&n.forEach((e=>s.style.removeProperty(e)))}function Z(e,t){const n=Math.round(e);return Math.abs(n-e)<t?n:e}function U(e){const t=window.getComputedStyle(document.body).getPropertyValue(e)||"#ffffff";return j.rgb(t).formatHex()}class Y{constructor(e,t){this.ctx=e,this.gridSize=t,this.x=0,this.y=0,this.scale=1}apply(){this.ctx.setTransform(this.scale,0,0,this.scale,this.x,this.y)}scaleAt(e,t,n){this.scale*=n,this.x=e-(e-this.x)*n,this.y=t-(t-this.y)*n}toWorld(e,t=!1,n=.1){const s=1/this.scale;let o=(e.x-this.x)*s,i=(e.y-this.y)*s;return t&&(o=Z(o/this.gridSize,n)*this.gridSize,i=Z(i/this.gridSize,n)*this.gridSize),{x:o,y:i}}toScreen(e){return{x:e.x*this.scale+this.x,y:e.y*this.scale+this.y}}}class J extends p.Component{constructor(e){super(e),this.handleMouseMove=e=>{const t=this.props.model,n=this.globalToLocalPos({x:e.pageX,y:e.pageY}),s=this.screenToWorldPos(n);switch(this.state.mode){case"LINE":if("LINE"===t.editing.type){const e=t.editing.content.startPoint,n=t.editing.content.tempId,o=t.getPointById(e);if(o){n&&t.removeLine(n);const e=t.addLine(o.position,s);t.updateEdit("LINE",Object.assign(Object.assign({},t.editing.content),{tempId:e}))}}break;case"CIRCLE":if("CIRCLE"===t.editing.type){const e=t.editing.content.centerId,n=t.editing.content.tempId,o=t.getPointById(e);if(o){n&&t.removeCircle(n);const e=v(s,o.position),i=t.addCircle(o.position,e);t.updateEdit("CIRCLE",Object.assign(Object.assign({},t.editing.content),{tempId:i}))}}}},this.handleRightClick=e=>{if(2!==e.button)return;const t=this.props.model;if(this.state.mode)t.stopEdit(!0),this.setState((e=>Object.assign(Object.assign({},e),{mode:void 0})));else{const n=this.globalToLocalPos({x:e.pageX,y:e.pageY}),s=this.screenToWorldPos(n),o=t.getPointByPosition(s);o&&(t.getLineByControlPoint(o).forEach((e=>t.removeLine(e))),t.getCircleByControlPoint(o).forEach((e=>{var n;const s=t.getCircleById(e);null===(n=null==s?void 0:s.controlPoints)||void 0===n||n.forEach((e=>t.removePoint(e))),t.removeCircle(e)})),t.removePoint(o))}},this.handleLeftClick=e=>{if(!this.ctx)return;const{model:t}=this.props,n=this.globalToLocalPos({x:e.pageX,y:e.pageY}),s=this.screenToWorldPos(n);switch(this.state.mode){case"LINE":if("LINE"===t.editing.type){t.addPoint(s,{color:"#ffffff00"});const e=t.editing.content.tempId,n=t.getLineById(e),o={x:(n.start.x+n.end.x)/2,y:(n.start.y+n.end.y)/2},i=t.addPoint(o,{color:"red"});n.controlPoints=[i],t.stopEdit()}else{const e=t.addPoint(s,{color:"#ffffff00"});t.startEdit("LINE",{startPoint:e})}break;case"CIRCLE":if("CIRCLE"===t.editing.type){const e=t.editing.content.centerId,n=t.editing.content.tempId,o=t.getCircleById(n),i=t.addPoint(s,{color:"red"});o.controlPoints=[i,e],t.stopEdit()}else{const e=t.addPoint(s,{color:"red"});t.startEdit("CIRCLE",{centerId:e,radius:0})}break;case"POINT":t.addPoint(s)}},this.mousePanAnZoom=e=>{if(!this._canvasRef.current)return;const t=this.globalToLocalPos({x:e.pageX,y:e.pageY});this._mouse.x=t.x,this._mouse.y=t.y,this._mouse.button="mousedown"===e.type&&2===e.button||"mouseup"!==e.type&&this._mouse.button,"wheel"===e.type&&(this._mouse.wheel+=-e.deltaY,e.preventDefault());const n=this.screenToWorldPos(this._mouse);n&&this.setState((e=>Object.assign(Object.assign({},e),{currentPointer:{x:parseFloat((n.x/this._gridSize).toFixed(2)),y:parseFloat((n.y/this._gridSize).toFixed(2))}})))},this.drawGrid=(e=128)=>{if(!this._canvasRef.current)return;const t=this._panZoom,n=this._canvasRef.current,s=n.getContext("2d"),o=n.width,i=n.height,a=e;let r=Math.max(o,i)/t.scale+2*a;this._topLeft=t.toWorld({x:0,y:0});const d=Math.floor(this._topLeft.x/a)*a,l=Math.floor(this._topLeft.y/a)*a;r/a>this._gridLimit&&(r=a*this._gridLimit),t.apply(),s.lineWidth=.5,s.strokeStyle="#ccc",s.beginPath();for(let e=0;e<r;e+=a)s.moveTo(d+e,l),s.lineTo(d+e,l+r),s.moveTo(d,l+e),s.lineTo(d+r,l+e);s.setTransform(1,0,0,1,0,0),s.stroke(),s.closePath(),this.drawCenter(r)},this.drawCenter=e=>{const t=this._panZoom,n=this._canvasRef.current.getContext("2d"),s=t.toScreen({x:0,y:0});n.lineWidth=1,n.strokeStyle="#000",n.beginPath(),n.moveTo(s.x,s.y),n.lineTo(s.x,s.y+e),n.moveTo(s.x,s.y),n.lineTo(s.x,s.y-e),n.moveTo(s.x,s.y),n.lineTo(s.x+e,s.y),n.moveTo(s.x,s.y),n.lineTo(s.x-e,s.y),n.stroke(),n.setTransform(1,0,0,1,0,0),n.closePath()},this.drawPointer=(e,t)=>{const n=this._panZoom,s=this._canvasRef.current,o=s.getContext("2d"),i=this.screenToWorldPos({x:e,y:t});n.apply(),o.lineWidth=.5,o.strokeStyle="#000",o.beginPath(),o.moveTo(i.x-2/n.scale*s.width,i.y),o.lineTo(i.x+2/n.scale*s.width,i.y),o.moveTo(i.x,i.y-2/n.scale*s.height),o.lineTo(i.x,i.y+2/n.scale*s.height),o.setTransform(1,0,0,1,0,0),o.stroke(),o.closePath(),g(o,n.toScreen(i),"crimson")},this.draw=()=>{const e=this.ctx;if(!e)return;const{model:t}=this.props,n=this._panZoom;t.points.forEach(((t,s)=>{var o;const i=n.toScreen(t.position),a=null===(o=t.option)||void 0===o?void 0:o.color;g(e,i,a)})),t.lines.forEach((t=>{const s=n.toScreen(t.start),o=n.toScreen(t.end);!function(e,t,n,s,o=.5){e.save(),e.lineWidth=o,e.strokeStyle=s,e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(n.x,n.y),e.setTransform(1,0,0,1,0,0),e.stroke(),e.closePath(),e.restore()}(e,s,o,"blue",1)})),t.circles.forEach((t=>{const{center:s}=t,o={x:s.x+t.radius,y:s.y},i=n.toScreen(s),a=v(i,n.toScreen(o));!function(e,t,n,s,o=1){e.save(),e.lineWidth=o,e.strokeStyle=s,e.beginPath(),e.arc(t.x,t.y,n,0,2*Math.PI),e.stroke(),e.closePath(),e.restore()}(e,i,a,"blue",1)}))},this.update=()=>{const e=this._canvasRef.current,t=this._divRef.current,n=null==e?void 0:e.getContext("2d");if(!e||!n||!t)return;const s=this._mouse,o=this._panZoom;n.setTransform(1,0,0,1,0,0),n.globalAlpha=1;const i=t.getBoundingClientRect();if(e.width!==i.width||e.height!==i.height-30?(e.height=i.height-30,e.width=i.width):n.clearRect(0,0,e.width,e.height),0!==s.wheel){let e=1;e=s.wheel<0?1/this._scaleRate:this._scaleRate,s.wheel*=.8,Math.abs(s.wheel)<1&&(s.wheel=0),o.scaleAt(s.x,s.y,e)}s.button?s.drag?(o.x+=s.x-s.lastX,o.y+=s.y-s.lastY,s.lastX=s.x,s.lastY=s.y):(s.lastX=s.x,s.lastY=s.y,s.drag=!0):s.drag&&(s.drag=!1),this.drawGrid(this._gridSize),this.drawPointer(s.x,s.y),this.draw(),requestAnimationFrame(this.update)},this.globalToLocalPos=e=>{const t=this._canvasRef.current.getBoundingClientRect();return{x:e.x-t.left-scrollX,y:e.y-t.top-scrollY}},this.screenToWorldPos=e=>{let t=this._panZoom.toWorld(e,!0);const n=this.props.model.getPointByPosition(t);return n&&(t=this.props.model.getPointById(n).position),t},this.toggleMode=e=>()=>{this.state.mode!==e?this.setState((t=>Object.assign(Object.assign({},t),{mode:e}))):this.setState((e=>Object.assign(Object.assign({},e),{mode:void 0})))},this.saveButtonOnClick=async()=>{this.state.sketchName&&(await this.props.model.save(this.state.sketchName,this.state.plane),this.props.closeCallback.handler())},this._mouse={x:0,y:0,button:!1,wheel:0,lastX:0,lastY:0,drag:!1},this._gridLimit=128,this._scaleRate=1.02,this._topLeft={x:0,y:0},this._divRef=p.createRef(),this._canvasRef=p.createRef(),this.state={plane:"XY"},this._gridSize=e.model.gridSize}componentDidMount(){setTimeout((()=>{this.initiateEditor()}),100)}get ctx(){const e=this._canvasRef.current;return e?e.getContext("2d"):null}initiateEditor(){const e=this._divRef.current;if(!e)return;const t=this._canvasRef.current;if(!t)return;const n=e.getBoundingClientRect();(null==n?void 0:n.width)&&(null==n?void 0:n.height)&&(t.height=n.height-30,t.width=n.width),["mousedown","mouseup","mousemove"].forEach((e=>t.addEventListener(e,this.mousePanAnZoom))),t.addEventListener("wheel",this.mousePanAnZoom,{passive:!1}),t.addEventListener("mousedown",this.handleRightClick),t.addEventListener("click",this.handleLeftClick),t.addEventListener("mousemove",this.handleMouseMove);const s=t.getContext("2d");this._panZoom=new Y(s,this._gridSize),this._panZoom.x=t.width/2,this._panZoom.y=t.height/2,requestAnimationFrame(this.update)}render(){var e,t;return p.createElement("div",{className:"jpcad-sketcher-Sketcher",ref:this._divRef,style:{overflow:"hidden",width:"100%",height:"100%"}},p.createElement("div",{className:"lm-Widget jp-Toolbar jpcad-sketcher-Sketcher-Toolbar"},p.createElement("div",{className:"jp-HTMLSelect jp-DefaultStyle jp-Notebook-toolbarCellTypeDropdown"},p.createElement("select",{onChange:e=>this.setState((t=>Object.assign(Object.assign({},t),{plane:e.target.value})))},p.createElement("option",{value:"XY"},"XY-plane"),p.createElement("option",{value:"YZ"},"YZ-plane"),p.createElement("option",{value:"ZX"},"ZX-Plane"))),p.createElement("div",{style:{boxShadow:"0 0 3px var(--jp-border-color0) inset",display:"flex"}},["POINT","LINE","CIRCLE"].map((e=>p.createElement(y,{key:e,label:e,toggled:this.state.mode===e,onClick:this.toggleMode(e)})))),p.createElement("div",{style:{flexGrow:1}}),p.createElement("input",{style:{height:25},className:"jp-mod-styled",type:"text",placeholder:"Sketch name",value:this.state.sketchName,onChange:e=>this.setState((t=>Object.assign(Object.assign({},t),{sketchName:e.target.value})))}),p.createElement(y,{label:"Save",toggled:!1,onClick:this.saveButtonOnClick}),p.createElement(c.ToolbarButtonComponent,{icon:c.closeIcon,onClick:()=>{this.props.closeCallback.handler()}})),p.createElement("canvas",{className:"jpcad-sketcher-Sketcher-Canvas",ref:this._canvasRef}),p.createElement("div",{className:"jpcad-sketcher-Sketcher-Statusbar"},"X: ",null===(e=this.state.currentPointer)||void 0===e?void 0:e.x," - Y: ",null===(t=this.state.currentPointer)||void 0===t?void 0:t.y))}}class q extends o.Dialog{constructor(e){const t=new w({gridSize:64,sharedModel:e.sharedModel});super({title:"Sketcher",body:p.createElement(J,{model:t,closeCallback:e.closeCallback}),buttons:[],hasClose:!1}),this.addClass("jpcad-sketcher-SketcherDialog")}}var X=n(4463),H=n(5633);const $=e=>{const t=p.useRef(null),{children:n}=e;return p.useEffect((()=>{const e=n;try{H.MessageLoop.sendMessage(e,m.Widget.Msg.BeforeAttach),t.current.insertBefore(e.node,null),H.MessageLoop.sendMessage(e,m.Widget.Msg.AfterAttach)}catch(e){console.warn("Exception while attaching Lumino widget.",e)}return()=>{try{(e.isAttached||e.node.isConnected)&&m.Widget.detach(e)}catch(e){console.warn("Exception while detaching Lumino widget.",e)}}}),[n]),p.createElement("div",{ref:t})};class K extends p.Component{constructor(e){super(e),this.setStateByKey=(e,t)=>{const n=parseFloat(t);Number.isNaN(n)||this.setState((t=>Object.assign(Object.assign({},t),{internalData:Object.assign(Object.assign({},t.internalData),{[e]:n})})),(()=>this.props.syncData({[e]:n})))},this.onFormSubmit=e=>{const t=Object.assign({},this.state.internalData);Object.entries(e.formData).forEach((([e,n])=>t[e]=n)),this.setState((e=>Object.assign(Object.assign({},e),{internalData:t})),(()=>{this.props.syncData(e.formData),this.props.cancel&&this.props.cancel()}))},this.state={internalData:Object.assign({},this.props.sourceData),schema:e.schema}}componentDidUpdate(e,t){e.sourceData!==this.props.sourceData&&this.setState((e=>Object.assign(Object.assign({},e),{internalData:this.props.sourceData})))}buildForm(){if(!this.props.sourceData||!this.state.internalData)return[];const e=[];for(const[t,n]of Object.entries(this.props.sourceData)){let s;"string"!=typeof n&&"number"!=typeof n||(s=p.createElement("div",{key:t},p.createElement("label",{htmlFor:""},t),p.createElement("input",{type:"number",value:this.state.internalData[t],onChange:e=>this.setStateByKey(t,e.target.value)})),e.push(s))}return e}removeArrayButton(e,t){Object.entries(e.properties).forEach((([e,n])=>{"array"===n.type?t[e]={"ui:options":{orderable:!1,removable:!1,addable:!1}}:"object"===n.type&&(t[e]={},this.removeArrayButton(n,t[e]))}))}generateUiSchema(e){const t={additionalProperties:{"ui:label":!1,classNames:"jpcad-hidden-field"}};return this.removeArrayButton(e,t),t}render(){var e;if(this.props.schema){const t=Object.assign(Object.assign({},this.props.schema),{additionalProperties:!0}),n=p.createRef(),s=new X.SchemaForm(null!=t?t:{},{liveValidate:!0,formData:this.state.internalData,onSubmit:this.onFormSubmit,onFocus:(e,t)=>{this.props.syncSelectedField&&this.props.syncSelectedField(e,t,this.props.parentType)},onBlur:(e,t)=>{this.props.syncSelectedField&&this.props.syncSelectedField(null,t,this.props.parentType)},uiSchema:this.generateUiSchema(this.props.schema),children:p.createElement("button",{ref:n,type:"submit",style:{display:"none"}})});return p.createElement("div",{className:"jpcad-property-panel","data-path":null!==(e=this.props.filePath)&&void 0!==e?e:""},p.createElement("div",{className:"jpcad-property-outer"},p.createElement($,null,s)),p.createElement("div",{className:"jpcad-property-buttons"},this.props.cancel?p.createElement("button",{className:"jp-Dialog-button jp-mod-reject jp-mod-styled",onClick:this.props.cancel},p.createElement("div",{className:"jp-Dialog-buttonLabel"},"Cancel")):null,p.createElement("button",{className:"jp-Dialog-button jp-mod-accept jp-mod-styled",onClick:()=>{var e;return null===(e=n.current)||void 0===e?void 0:e.click()}},p.createElement("div",{className:"jp-Dialog-buttonLabel"},"Submit"))))}return p.createElement("div",null,this.buildForm())}}class Q extends o.Dialog{constructor(e){let t;e.cancelButton&&(t=()=>{!0!==e.cancelButton&&!1!==e.cancelButton&&e.cancelButton(),this.resolve(0)});const n=e.context.path,s=e.context.model,i=p.createElement("div",{style:{overflow:"hidden"}},p.createElement(K,{parentType:"dialog",filePath:`${n}::dialog`,sourceData:e.sourceData,schema:e.schema,syncData:e.syncData,cancel:t,syncSelectedField:e.syncSelectedPropField}));let a;null==s||s.clientStateChanged.connect(((e,t)=>{var o,i,r,d,l;const c=null===(o=null==s?void 0:s.localState)||void 0===o?void 0:o.remoteUser;if(c){const e=t.get(c),s=null===(i=null==e?void 0:e.selectedPropField)||void 0===i?void 0:i.id,o=null===(r=null==e?void 0:e.selectedPropField)||void 0===r?void 0:r.value;"dialog"===(null===(d=null==e?void 0:e.selectedPropField)||void 0===d?void 0:d.parentType)&&(a=W(`${n}::dialog`,s,o,null===(l=null==e?void 0:e.user)||void 0===l?void 0:l.color,a))}else a&&(G(`${n}::dialog`,a,["border-color","box-shadow"]),a=void 0)})),super({title:e.title,body:i,buttons:[o.Dialog.cancelButton()]}),this.addClass("jpcad-property-FormDialog")}}const ee=JSON.parse('{"Part::GeomCircle":{"type":"object","required":["TypeId","CenterX","CenterY","CenterZ","NormalX","NormalY","NormalZ","AngleXU","Radius"],"additionalProperties":false,"properties":{"TypeId":{"const":"Part::GeomCircle","description":"Geometry type"},"CenterX":{"type":"number","description":"CenterX"},"CenterY":{"type":"number","description":"CenterY"},"CenterZ":{"type":"number","description":"CenterZ"},"NormalX":{"type":"number","description":"NormalX"},"NormalY":{"type":"number","description":"NormalY"},"NormalZ":{"type":"number","description":"NormalZ"},"AngleXU":{"type":"number","description":"AngleXU"},"Radius":{"type":"number","description":"Radius"}}},"Part::GeomLineSegment":{"type":"object","required":["TypeId","StartX","StartY","StartZ","EndX","EndY","EndZ"],"additionalProperties":false,"properties":{"TypeId":{"const":"Part::GeomLineSegment","description":"Geometry type"},"StartX":{"type":"number","description":"StartX"},"StartY":{"type":"number","description":"StartY"},"StartZ":{"type":"number","description":"StartZ"},"EndX":{"type":"number","description":"EndX"},"EndY":{"type":"number","description":"EndY"},"EndZ":{"type":"number","description":"EndZ"}}},"Placement of the box":{"type":"object","additionalProperties":false,"required":["Position","Axis","Angle"],"properties":{"Position":{"type":"array","description":"Position of the Placement","items":{"type":"number"}},"Axis":{"type":"array","description":"Axis of the Placement","items":{"type":"number"}},"Angle":{"type":"number","description":"Angle of the Placement"}}},"Part::Box":{"type":"object","required":["Length","Width","Height","Placement"],"additionalProperties":false,"properties":{"Length":{"type":"number","description":"The length of the box"},"Width":{"type":"number","description":"The width of the box"},"Height":{"type":"number","description":"The height of the box"},"Placement":{"type":"object","description":"Placement of the box","additionalProperties":false,"required":["Position","Axis","Angle"],"properties":{"Position":{"type":"array","description":"Position of the Placement","items":{"type":"number"}},"Axis":{"type":"array","description":"Axis of the Placement","items":{"type":"number"}},"Angle":{"type":"number","description":"Angle of the Placement"}}}}},"Part::Cut":{"type":"object","required":["Base","Tool","Refine","Placement"],"additionalProperties":false,"properties":{"Base":{"type":"string","description":"The base of the cut operator","fcType":"App::PropertyLink"},"Tool":{"type":"string","description":"The tool of the cut operator","fcType":"App::PropertyLink"},"Refine":{"type":"boolean","description":"Refine shape"},"Placement":{"type":"object","description":"Placement of the box","additionalProperties":false,"required":["Position","Axis","Angle"],"properties":{"Position":{"type":"array","description":"Position of the Placement","items":{"type":"number"}},"Axis":{"type":"array","description":"Axis of the Placement","items":{"type":"number"}},"Angle":{"type":"number","description":"Angle of the Placement"}}}}},"Part::Cylinder":{"type":"object","required":["Radius","Angle","Height","Placement"],"additionalProperties":false,"properties":{"Radius":{"type":"number","description":"Radius of the cylinder"},"Height":{"type":"number","description":"Height of the cylinder"},"Angle":{"type":"number","description":"Angle of the cylinder"},"Placement":{"type":"object","description":"Placement of the box","additionalProperties":false,"required":["Position","Axis","Angle"],"properties":{"Position":{"type":"array","description":"Position of the Placement","items":{"type":"number"}},"Axis":{"type":"array","description":"Axis of the Placement","items":{"type":"number"}},"Angle":{"type":"number","description":"Angle of the Placement"}}}}},"Part::Extrusion":{"type":"object","required":["Base","Dir","LengthFwd","LengthRev","Solid","Placement"],"additionalProperties":false,"properties":{"Base":{"type":"string","description":"Shape to extrude","fcType":"App::PropertyLink"},"Dir":{"type":"array","description":"Direction of extrusion","items":{"type":"number"}},"LengthFwd":{"type":"number","description":"Length of extrusion along the direction"},"LengthRev":{"type":"number","description":"Length of extrusion against the direction"},"Solid":{"type":"boolean","description":"If true, creating a solid"},"Placement":{"type":"object","description":"Placement of the box","additionalProperties":false,"required":["Position","Axis","Angle"],"properties":{"Position":{"type":"array","description":"Position of the Placement","items":{"type":"number"}},"Axis":{"type":"array","description":"Axis of the Placement","items":{"type":"number"}},"Angle":{"type":"number","description":"Angle of the Placement"}}}}},"Part::Cone":{"type":"object","required":["Radius1","Radius2","Height","Angle","Placement"],"additionalProperties":false,"properties":{"Radius1":{"type":"number","description":"The bottom radius of the cone"},"Radius2":{"type":"number","description":"The top radius of the cone"},"Height":{"type":"number","description":"The height of the cone"},"Angle":{"type":"number","description":"The angle of the cone"},"Placement":{"type":"object","description":"Placement of the box","additionalProperties":false,"required":["Position","Axis","Angle"],"properties":{"Position":{"type":"array","description":"Position of the Placement","items":{"type":"number"}},"Axis":{"type":"array","description":"Axis of the Placement","items":{"type":"number"}},"Angle":{"type":"number","description":"Angle of the Placement"}}}}},"Part::MultiFuse":{"type":"object","required":["Shapes","Refine","Placement"],"additionalProperties":false,"properties":{"Shapes":{"type":"array","description":"The shapes of the individual elements","fcType":"App::PropertyLinkList","items":{"type":"string"}},"Refine":{"type":"boolean","description":"Refine shape"},"Placement":{"type":"object","description":"Placement of the box","additionalProperties":false,"required":["Position","Axis","Angle"],"properties":{"Position":{"type":"array","description":"Position of the Placement","items":{"type":"number"}},"Axis":{"type":"array","description":"Axis of the Placement","items":{"type":"number"}},"Angle":{"type":"number","description":"Angle of the Placement"}}}}},"Part::MultiCommon":{"type":"object","required":["Shapes","Refine","Placement"],"additionalProperties":false,"properties":{"Shapes":{"type":"array","description":"The objects to intersect","fcType":"App::PropertyLinkList","items":{"type":"string"}},"Refine":{"type":"boolean","description":"Refine shape"},"Placement":{"type":"object","description":"Placement of the box","additionalProperties":false,"required":["Position","Axis","Angle"],"properties":{"Position":{"type":"array","description":"Position of the Placement","items":{"type":"number"}},"Axis":{"type":"array","description":"Axis of the Placement","items":{"type":"number"}},"Angle":{"type":"number","description":"Angle of the Placement"}}}}},"Sketcher::SketchObject":{"type":"object","required":["AttachmentOffset","Geometry"],"additionalProperties":false,"properties":{"AttachmentOffset":{"description":"The attachment offset","type":"object","additionalProperties":false,"required":["Position","Axis","Angle"],"properties":{"Position":{"type":"array","description":"Position of the Placement","items":{"type":"number"}},"Axis":{"type":"array","description":"Axis of the Placement","items":{"type":"number"}},"Angle":{"type":"number","description":"Angle of the Placement"}}},"Geometry":{"type":"array","description":"The geometry list","items":{"anyOf":[{"type":"object","description":"Part::GeomCircle","title":"IGeomCircle","required":["TypeId","CenterX","CenterY","CenterZ","NormalX","NormalY","NormalZ","AngleXU","Radius"],"additionalProperties":false,"properties":{"TypeId":{"const":"Part::GeomCircle","description":"Geometry type"},"CenterX":{"type":"number","description":"CenterX"},"CenterY":{"type":"number","description":"CenterY"},"CenterZ":{"type":"number","description":"CenterZ"},"NormalX":{"type":"number","description":"NormalX"},"NormalY":{"type":"number","description":"NormalY"},"NormalZ":{"type":"number","description":"NormalZ"},"AngleXU":{"type":"number","description":"AngleXU"},"Radius":{"type":"number","description":"Radius"}}},{"type":"object","description":"Part::GeomLineSegment","title":"IGeomLineSegment","required":["TypeId","StartX","StartY","StartZ","EndX","EndY","EndZ"],"additionalProperties":false,"properties":{"TypeId":{"const":"Part::GeomLineSegment","description":"Geometry type"},"StartX":{"type":"number","description":"StartX"},"StartY":{"type":"number","description":"StartY"},"StartZ":{"type":"number","description":"StartZ"},"EndX":{"type":"number","description":"EndX"},"EndY":{"type":"number","description":"EndY"},"EndZ":{"type":"number","description":"EndZ"}}}]}},"Placement":{"type":"object","description":"Placement of the box","additionalProperties":false,"required":["Position","Axis","Angle"],"properties":{"Position":{"type":"array","description":"Position of the Placement","items":{"type":"number"}},"Axis":{"type":"array","description":"Axis of the Placement","items":{"type":"number"}},"Angle":{"type":"number","description":"Angle of the Placement"}}}}},"Part::Sphere":{"type":"object","required":["Radius","Angle1","Angle2","Angle3","Placement"],"additionalProperties":false,"properties":{"Radius":{"type":"number","description":"The radius of the sphere"},"Angle1":{"type":"number","description":"The angle of the sphere"},"Angle2":{"type":"number","description":"The angle of the sphere"},"Angle3":{"type":"number","description":"The angle of the sphere"},"Placement":{"type":"object","description":"Placement of the box","additionalProperties":false,"required":["Position","Axis","Angle"],"properties":{"Position":{"type":"array","description":"Position of the Placement","items":{"type":"number"}},"Axis":{"type":"array","description":"Axis of the Placement","items":{"type":"number"}},"Angle":{"type":"number","description":"Angle of the Placement"}}}}},"Part::Any":{"type":"object","required":["Shape"],"additionalProperties":false,"properties":{"Shape":{"type":"string","description":"The BREP string of the shape"},"Placement":{"type":"object","description":"Placement of the box","additionalProperties":false,"required":["Position","Axis","Angle"],"properties":{"Position":{"type":"array","description":"Position of the Placement","items":{"type":"number"}},"Axis":{"type":"array","description":"Axis of the Placement","items":{"type":"number"}},"Angle":{"type":"number","description":"Angle of the Placement"}}}}},"Part::Torus":{"type":"object","required":["Radius1","Radius2","Angle1","Angle2","Angle3","Placement"],"additionalProperties":false,"properties":{"Radius1":{"type":"number","description":"The radius of the torus"},"Radius2":{"type":"number","description":"The radius of the torus"},"Angle1":{"type":"number","description":"The angle of the torus"},"Angle2":{"type":"number","description":"The angle of the torus"},"Angle3":{"type":"number","description":"The angle of the torus"},"Placement":{"type":"object","description":"Placement of the box","additionalProperties":false,"required":["Position","Axis","Angle"],"properties":{"Position":{"type":"array","description":"Position of the Placement","items":{"type":"number"}},"Axis":{"type":"array","description":"Axis of the Placement","items":{"type":"number"}},"Angle":{"type":"number","description":"Angle of the Placement"}}}}}}');var te=function(e,t){var n={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(n[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(s=Object.getOwnPropertySymbols(e);o<s.length;o++)t.indexOf(s[o])<0&&Object.prototype.propertyIsEnumerable.call(e,s[o])&&(n[s[o]]=e[s[o]])}return n};const ne={};function se(e,t){const n=t.sharedModel;let s=1,o=`${e} 1`;for(;n.objectExists(o);)o=`${e} ${++s}`;return o}Object.keys(ee).forEach((e=>{if("Placement of the box"===e)return;const t=ne[e]=JSON.parse(JSON.stringify(ee[e]));t.required=["Name",...t.required],t.properties=Object.assign({Name:{type:"string",description:"The Name of the Object"}},t.properties)}));const oe={box:{title:"Box parameters",shape:"Part::Box",default:e=>({Name:se("Box",e),Length:1,Width:1,Height:1,Placement:{Position:[0,0,0],Axis:[0,0,1],Angle:0}})},cylinder:{title:"Cylinder parameters",shape:"Part::Cylinder",default:e=>({Name:se("Cylinder",e),Radius:1,Height:1,Angle:360,Placement:{Position:[0,0,0],Axis:[0,0,1],Angle:0}})},sphere:{title:"Sphere parameters",shape:"Part::Sphere",default:e=>({Name:se("Sphere",e),Radius:5,Angle1:-90,Angle2:90,Angle3:360,Placement:{Position:[0,0,0],Axis:[0,0,1],Angle:0}})},cone:{title:"Cone parameters",shape:"Part::Cone",default:e=>({Name:se("Cone",e),Radius1:1,Radius2:.5,Height:1,Angle:360,Placement:{Position:[0,0,0],Axis:[0,0,1],Angle:0}})},torus:{title:"Torus parameters",shape:"Part::Torus",default:e=>({Name:se("Torus",e),Radius1:10,Radius2:2,Angle1:-180,Angle2:180,Angle3:360,Placement:{Position:[0,0,0],Axis:[0,0,1],Angle:0}})}};function ie(e,t,n){const s=e.getOption("guidata")||{};s&&s[t]?s[t].visibility=!1:s[t]={visibility:!1},e.setOption("guidata",s)}const ae={cut:{title:"Cut parameters",shape:"Part::Cut",default:e=>{var t,n,s;const o=e.getAllObject(),i=(null===(t=e.localState)||void 0===t?void 0:t.selected.value)||[];return{Name:se("Cut",e),Base:i.length>0?i[0]:null!==(n=o[0].name)&&void 0!==n?n:"",Tool:i.length>1?i[1]:null!==(s=o[1].name)&&void 0!==s?s:"",Refine:!1,Placement:{Position:[0,0,0],Axis:[0,0,1],Angle:0}}},syncData:e=>t=>{const{Name:n}=t,s=te(t,["Name"]),i={shape:"Part::Cut",parameters:s,visible:!0,name:n},a=e.sharedModel;a&&a.transact((()=>{ie(a,s.Base),ie(a,s.Tool),a.objectExists(i.name)?(0,o.showErrorMessage)("The object already exists","There is an existing object with the same name."):a.addObject(i)}))}},extrusion:{title:"Extrusion parameters",shape:"Part::Extrusion",default:e=>{var t,n;const s=e.getAllObject(),o=(null===(t=e.localState)||void 0===t?void 0:t.selected.value)||[];return{Name:se("Extrusion",e),Base:[o.length>0?o[0]:null!==(n=s[0].name)&&void 0!==n?n:""],Dir:[0,0,1],LengthFwd:10,LengthRev:0,Solid:!1,Placement:{Position:[0,0,0],Axis:[0,0,1],Angle:0}}},syncData:e=>t=>{const{Name:n}=t,s=te(t,["Name"]),i={shape:"Part::Extrusion",parameters:s,visible:!0,name:n},a=e.sharedModel;a&&(ie(a,s.Base),a.transact((()=>{a.objectExists(i.name)?(0,o.showErrorMessage)("The object already exists","There is an existing object with the same name."):a.addObject(i)})))}},union:{title:"Fuse parameters",shape:"Part::MultiFuse",default:e=>{var t,n,s;const o=e.getAllObject(),i=(null===(t=e.localState)||void 0===t?void 0:t.selected.value)||[];return{Name:se("Union",e),Shapes:[i.length>0?i[0]:null!==(n=o[0].name)&&void 0!==n?n:"",i.length>1?i[1]:null!==(s=o[1].name)&&void 0!==s?s:""],Refine:!1,Placement:{Position:[0,0,0],Axis:[0,0,1],Angle:0}}},syncData:e=>t=>{const{Name:n}=t,s=te(t,["Name"]),i={shape:"Part::MultiFuse",parameters:s,visible:!0,name:n},a=e.sharedModel;a&&a.transact((()=>{s.Shapes.map((e=>{ie(a,e)})),a.objectExists(i.name)?(0,o.showErrorMessage)("The object already exists","There is an existing object with the same name."):a.addObject(i)}))}},intersection:{title:"Intersection parameters",shape:"Part::MultiCommon",default:e=>{var t,n,s;const o=e.getAllObject(),i=(null===(t=e.localState)||void 0===t?void 0:t.selected.value)||[];return{Name:se("Intersection",e),Shapes:[i.length>0?i[0]:null!==(n=o[0].name)&&void 0!==n?n:"",i.length>1?i[1]:null!==(s=o[1].name)&&void 0!==s?s:""],Refine:!1,Placement:{Position:[0,0,0],Axis:[0,0,1],Angle:0}}},syncData:e=>t=>{const{Name:n}=t,s=te(t,["Name"]),i={shape:"Part::MultiCommon",parameters:s,visible:!0,name:n},a=e.sharedModel;a&&a.transact((()=>{s.Shapes.map((e=>{ie(a,e)})),a.objectExists(i.name)?(0,o.showErrorMessage)("The object already exists","There is an existing object with the same name."):a.addObject(i)}))}}},re={title:"Axes Helper",schema:{type:"object",required:["Size","Visible"],additionalProperties:!1,properties:{Size:{type:"number",description:"Size of the axes"},Visible:{type:"boolean",description:"Whether the axes are visible or not"}}},default:e=>{var t,n,s,o;return{Size:null!==(n=null===(t=e.axes)||void 0===t?void 0:t.size)&&void 0!==n?n:5,Visible:null===(o=null===(s=e.axes)||void 0===s?void 0:s.visible)||void 0===o||o}},syncData:e=>t=>{const{Size:n,Visible:s}=t;e.axes={size:n,visible:s}}},de={title:"Exploded View Settings",schema:{type:"object",required:["Enabled","Factor"],additionalProperties:!1,properties:{Enabled:{type:"boolean",description:"Whether the exploded view is enabled or not"},Factor:{type:"number",description:"The exploded view factor"}}},default:e=>{var t,n,s,o;return{Enabled:null!==(n=null===(t=e.explodedView)||void 0===t?void 0:t.enabled)&&void 0!==n&&n,Factor:null!==(o=null===(s=e.explodedView)||void 0===s?void 0:s.factor)&&void 0!==o?o:.5}},syncData:e=>t=>{const{Enabled:n,Factor:s}=t;e.explodedView={enabled:n,factor:s}}},le={title:"Camera Settings",schema:{type:"object",required:["Type"],additionalProperties:!1,properties:{Type:{title:"Projection",description:"The projection type",type:"string",enum:["Perspective","Orthographic"]}}},default:e=>{var t,n;return{Type:null!==(n=null===(t=e.cameraSettings)||void 0===t?void 0:t.type)&&void 0!==n?n:"Perspective"}},syncData:e=>t=>{const{Type:n}=t;e.cameraSettings={type:n}}};var ce,he;!function(e){e.redo="jupytercad:redo",e.undo="jupytercad:undo",e.newSketch="jupytercad:sketch",e.newBox="jupytercad:newBox",e.newCylinder="jupytercad:newCylinder",e.newSphere="jupytercad:newSphere",e.newCone="jupytercad:newCone",e.newTorus="jupytercad:newTorus",e.cut="jupytercad:cut",e.extrusion="jupytercad:extrusion",e.union="jupytercad:union",e.intersection="jupytercad:intersection",e.updateAxes="jupytercad:updateAxes",e.updateExplodedView="jupytercad:updateExplodedView",e.updateCameraSettings="jupytercad:updateCameraSettings"}(ce||(ce={})),function(e){e.createPart=function(e,t){return async n=>{const s=t.currentWidget;if(!s)return;const i=oe[e];s.context.model.syncFormData(i);const a=new Q({context:s.context,title:i.title,sourceData:i.default(s.context.model),schema:ne[i.shape],syncData:e=>{const{Name:t}=e,n=te(e,["Name"]),a={shape:i.shape,parameters:n,visible:!0,name:t},r=s.context.model.sharedModel;r&&(r.objectExists(a.name)?(0,o.showErrorMessage)("The object already exists","There is an existing object with the same name."):r.addObject(a))},cancelButton:()=>{s.context.model.syncFormData(void 0)},syncSelectedPropField:(e,t,n)=>{let o=null;if(e){const t=e.split("_")[0];o=e.substring(t.length)}s.context.model.syncSelectedPropField({id:o,value:t,parentType:n})}});await a.launch()}},e.executeOperator=function(e,t){return async n=>{const s=t.currentWidget;if(!s)return;const o=ae[e],i=JSON.parse(JSON.stringify(ne[o.shape])),a=s.context.model.getAllObject().map((e=>e.name));for(const e in i.properties){const t=i.properties[e].fcType;if(t){const n=i.properties[e];switch(t){case"App::PropertyLink":n.enum=a;break;case"App::PropertyLinkList":n.items.enum=a}}}const r=new Q({context:s.context,title:o.title,sourceData:o.default(s.context.model),schema:i,syncData:o.syncData(s.context.model),cancelButton:!0});await r.launch()}}}(he||(he={}));class pe extends p.Component{constructor(e){super(e),this.selectUser=e=>{var t;let n;e.userId!==(null===(t=this.state.selectedUser)||void 0===t?void 0:t.userId)&&(n=e),this.setState((e=>Object.assign(Object.assign({},e),{selectedUser:n})),(()=>{this._model.setUserToFollow(null==n?void 0:n.userId)}))},this._model=e.model,this.state={usersList:[]}}componentDidMount(){this.setState((e=>Object.assign(Object.assign({},e),{usersList:this._model.users}))),this._model.userChanged.connect(((e,t)=>{this.setState((e=>Object.assign(Object.assign({},e),{usersList:t})))}))}createUserIcon(e){var t;let n;const{userId:s,userData:o}=e,i=s===(null===(t=this.state.selectedUser)||void 0===t?void 0:t.userId)?"selected":"";return n=o.avatar_url?p.createElement("div",{key:s,title:o.display_name,className:`lm-MenuBar-itemIcon jp-MenuBar-imageIcon ${i}`,onClick:()=>this.selectUser(e)},p.createElement("img",{src:o.avatar_url,alt:""})):p.createElement("div",{key:s,title:o.display_name,className:`lm-MenuBar-itemIcon jp-MenuBar-anonymousIcon ${i}`,style:{backgroundColor:o.color},onClick:()=>this.selectUser(e)},p.createElement("span",null,o.initials)),n}render(){return p.createElement("div",{className:"jpcad-toolbar-usertoolbar"},this.state.usersList.map((e=>{if(e.userId!==this._model.currentUserId)return this.createUserIcon(e)})))}}class me extends m.Widget{constructor(){super(),this.addClass("jcad-Toolbar-Separator")}}class ue extends c.Toolbar{constructor(e){super(e),this.addClass("jpcad-toolbar-widget"),e.commands&&(this.addItem("undo",new o.CommandToolbarButton({id:ce.undo,label:"",icon:c.undoIcon,commands:e.commands})),this.addItem("redo",new o.CommandToolbarButton({id:ce.redo,label:"",icon:c.redoIcon,commands:e.commands})),this.addItem("separator1",new me),this.addItem("New Box",new o.CommandToolbarButton({id:ce.newBox,label:"",commands:e.commands})),this.addItem("New Cylinder",new o.CommandToolbarButton({id:ce.newCylinder,label:"",commands:e.commands})),this.addItem("New Sphere",new o.CommandToolbarButton({id:ce.newSphere,label:"",commands:e.commands})),this.addItem("New Cone",new o.CommandToolbarButton({id:ce.newCone,label:"",commands:e.commands})),this.addItem("New Torus",new o.CommandToolbarButton({id:ce.newTorus,label:"",commands:e.commands})),this.addItem("separator2",new me),this.addItem("Cut",new o.CommandToolbarButton({id:ce.cut,label:"",commands:e.commands})),this.addItem("Union",new o.CommandToolbarButton({id:ce.union,label:"",commands:e.commands})),this.addItem("Intersection",new o.CommandToolbarButton({id:ce.intersection,label:"",commands:e.commands})),this.addItem("Extrusion",new o.CommandToolbarButton({id:ce.extrusion,label:"",commands:e.commands})),this.addItem("separator3",new me),this.addItem("New Sketch",new o.CommandToolbarButton({id:ce.newSketch,label:"",commands:e.commands})),this.addItem("separator4",new me),this.addItem("Axes Helper",new o.CommandToolbarButton({id:ce.updateAxes,label:"",commands:e.commands})),this.addItem("Exploded View",new o.CommandToolbarButton({id:ce.updateExplodedView,label:"",commands:e.commands})),this.addItem("Camera Settings",new o.CommandToolbarButton({id:ce.updateCameraSettings,label:"",commands:e.commands})),this.addItem("spacer",c.Toolbar.createSpacerItem()),this.addItem("users",c.ReactWidget.create(p.createElement(pe,{model:e.model}))))}}var ge,ye,ve=n(2952),be=n(4901),fe=n(7120),_e=n(1189),we=n(9084),xe=n(1040);!function(e){e.LOAD_FILE="LOAD_FILE",e.SAVE_FILE="SAVE_FILE",e.REGISTER="REGISTER"}(ge||(ge={})),function(e){e.DISPLAY_SHAPE="DISPLAY_SHAPE",e.INITIALIZED="INITIALIZED"}(ye||(ye={}));const Ce=e=>{var t,n,s;const{self:o,message:i,user:a}=e,r=null!==(t=null==a?void 0:a.color)&&void 0!==t?t:"black",d=null!==(n=null==a?void 0:a.display_name)&&void 0!==n?n:"",l=null!==(s=null==a?void 0:a.initials)&&void 0!==s?s:"";return p.createElement("div",{className:"jcad-Annotation-Message",style:{flexFlow:o?"row":"row-reverse"}},p.createElement("div",{className:"jcad-Annotation-User-Icon",style:{backgroundColor:r},title:d},p.createElement("span",{style:{width:24,textAlign:"center"}},l)),p.createElement("div",{className:"jcad-Annotation-Message-Content"},p.createElement("p",{style:{padding:7,margin:0}},i)))},je=e=>{const{itemId:t,model:n}=e,s=n.getAnnotation(t),o=p.useMemo((()=>{var e;return null!==(e=null==s?void 0:s.contents)&&void 0!==e?e:[]}),[s]),[i,a]=p.useState("");if(!s)return p.createElement("div",null);const r=()=>{n.addContent(t,i),a("")};return p.createElement("div",{className:"jcad-Annotation"},e.children,p.createElement("div",{style:{paddingBottom:10,maxHeight:400,overflow:"auto"}},o.map((e=>{var t,s;return p.createElement(Ce,{user:e.user,message:e.value,self:(null===(t=n.user)||void 0===t?void 0:t.username)===(null===(s=e.user)||void 0===s?void 0:s.username)})}))),p.createElement("div",{className:"jcad-Annotation-Message"},p.createElement("textarea",{rows:3,placeholder:"Ctrl+Enter to submit",value:i,onChange:e=>a(e.currentTarget.value),onKeyDown:e=>{e.ctrlKey&&"Enter"===e.key&&r()}}),p.createElement("div",{onClick:r},p.createElement(c.caretRightIcon.react,{className:"jcad-Annotation-Submit"}))))},Pe=e=>{const{itemId:t,model:n}=e,[s,i]=p.useState(e.open),a=e=>{var s;return e?i(!0):(null===(s=n.getAnnotation(t))||void 0===s?void 0:s.contents.length)?void i(!1):n.removeAnnotation(t)};return p.createElement("div",null,p.createElement("div",{className:"jcad-Annotation-Handler",onClick:()=>a(!s)}),p.createElement("div",{className:"jcad-FloatingAnnotation",style:{visibility:s?"visible":"hidden"}},p.createElement(je,{model:n,itemId:t},p.createElement("div",{className:"jcad-Annotation-Topbar"},p.createElement("div",{onClick:async()=>{var e;if(!(null===(e=n.getAnnotation(t))||void 0===e?void 0:e.contents.length))return n.removeAnnotation(t);(await(0,o.showDialog)({title:"Delete Annotation",body:"Are you sure you want to delete this annotation?",buttons:[o.Dialog.cancelButton(),o.Dialog.okButton({label:"Delete"})]})).button.accept&&n.removeAnnotation(t)}},p.createElement(c.closeIcon.react,{className:"jcad-Annotation-TopBarIcon"})),p.createElement("div",{onClick:()=>{a(!1)}},p.createElement(M.react,{className:"jcad-Annotation-TopBarIcon"}))))))};_e.BufferGeometry.prototype.computeBoundsTree=we.computeBoundsTree,_e.BufferGeometry.prototype.disposeBoundsTree=we.disposeBoundsTree,_e.Mesh.prototype.raycast=we.acceleratedRaycast;const Se="--jp-inverse-layout-color4",Me="--jp-inverse-layout-color2",Ae="--jp-brand-color0",Oe=new _e.Color(U(Se)),Ee=new _e.Color(U(Me)),Te=new _e.Color(U(Ae));class Ie extends p.Component{constructor(e){super(e),this.addContextMenu=()=>{const e=new fe.CommandRegistry;e.addCommand("add-annotation",{execute:()=>{var e;if(!this._pointer3D)return;const t=(new _e.Vector3).copy(this._pointer3D.mesh.position);if(this._explodedView.enabled){const e=this._computeExplodedState(this._pointer3D.mesh);t.add(e.vector.multiplyScalar(-e.distance))}null===(e=this._model.annotationModel)||void 0===e||e.addAnnotation((0,u.v4)(),{position:[t.x,t.y,t.z],label:"New annotation",contents:[],parent:this._pointer3D.parent.name})},label:"Add annotation",isEnabled:()=>!!this._pointer3D}),this._contextMenu=new m.ContextMenu({commands:e}),this._contextMenu.addItem({command:"add-annotation",selector:"canvas",rank:1})},this.sceneSetup=()=>{if(null!==this.divRef.current){Oe.set(U(Se)),Ee.set(U(Me)),Te.set(U(Ae)),this._camera=new _e.PerspectiveCamera(90,2,.1,1e3),this._camera.position.set(8,8,8),this._camera.up.set(0,0,1),this._scene=new _e.Scene,this._scene.add(new _e.AmbientLight(16777215,.5)),this._cameraLight=new _e.PointLight(16777215,1),this._camera.add(this._cameraLight),this._scene.add(this._camera),this._renderer=new _e.WebGLRenderer({alpha:!0,antialias:!0}),this._renderer.setClearColor(0,0),this._renderer.setSize(500,500,!1),this.divRef.current.appendChild(this._renderer.domElement),this._syncPointer=R(((e,t)=>{e&&t?this._model.syncPointer({parent:t,x:e.x,y:e.y,z:e.z}):this._model.syncPointer(void 0)}),100),this._renderer.domElement.addEventListener("pointermove",this._onPointerMove.bind(this)),this._renderer.domElement.addEventListener("mouseup",(e=>{this._onClick.bind(this)(e)})),this._renderer.domElement.addEventListener("contextmenu",(e=>{e.preventDefault(),e.stopPropagation(),this._contextMenu.open(e)}));const e=new xe.z(this._camera,this._renderer.domElement);e.target.set(this._scene.position.x,this._scene.position.y,this._scene.position.z),this._controls=e,this._controls.addEventListener("change",(()=>{this._updateAnnotation()})),this._controls.addEventListener("change",R((()=>{var e;(null===(e=this._model.localState)||void 0===e?void 0:e.remoteUser)||this._model.syncCamera({position:this._camera.position.toArray([]),rotation:this._camera.rotation.toArray([]),up:this._camera.up.toArray([])},this.state.id)}),100))}},this.startAnimationLoop=()=>{this._requestID=window.requestAnimationFrame(this.startAnimationLoop),this._controls.update(),this._renderer.setRenderTarget(null),this._renderer.clearDepth(),this._renderer.render(this._scene,this._camera)},this.resizeCanvasToDisplaySize=()=>{null!==this.divRef.current&&(this._renderer.setSize(this.divRef.current.clientWidth,this.divRef.current.clientHeight,!1),"PerspectiveCamera"===this._camera.type?this._camera.aspect=this.divRef.current.clientWidth/this.divRef.current.clientHeight:(this._camera.left=this.divRef.current.clientWidth/-2,this._camera.right=this.divRef.current.clientWidth/2,this._camera.top=this.divRef.current.clientHeight/2,this._camera.bottom=this.divRef.current.clientHeight/-2),this._camera.updateProjectionMatrix())},this.generateScene=()=>{this.sceneSetup(),this.startAnimationLoop(),this.resizeCanvasToDisplaySize()},this.messageHandler=e=>{switch(e.action){case ye.DISPLAY_SHAPE:this._saveMeta(e.payload),this._shapeToMesh(e.payload);break;case ye.INITIALIZED:if(!this._model)return;this._postMessage({action:ge.LOAD_FILE,payload:{content:this._model.getContent()}})}},this._projectVector=e=>{const t=(new _e.Vector3).copy(e),n=this._renderer.domElement;return t.project(this._camera),new _e.Vector2((.5+t.x/2)*n.width,(.5-t.y/2)*n.height)},this._saveMeta=e=>{this._model&&Object.entries(e).forEach((([e,t])=>{this._model.sharedModel.setShapeMeta(e,t.meta)}))},this._shapeToMesh=e=>{var t;null!==this._meshGroup&&this._scene.remove(this._meshGroup),null!==this._explodedViewLinesHelperGroup&&this._scene.remove(this._explodedViewLinesHelperGroup);const n=this._model.sharedModel.getOption("guidata"),s=this._selectedMeshes.map((e=>e.name));if(this._selectedMeshes=[],this._boundingGroup=new _e.Box3,this._meshGroup=new _e.Group,Object.entries(e).forEach((([e,t])=>{const{faceList:o,edgeList:i,jcObject:a}=t,r=[],d=[],l=[];let c=0;if(0===o.length&&0===i.length)return;o.forEach((e=>{r.push(...e.vertexCoord),d.push(...e.normalCoord);for(let t=0;t<e.triIndexes.length;t+=3)l.push(e.triIndexes[t+0]+c,e.triIndexes[t+1]+c,e.triIndexes[t+2]+c);c+=e.vertexCoord.length/3}));let h=Oe,p=a.visible;if(n&&n[e]){const t=n[e];if(Object.prototype.hasOwnProperty.call(t,"color")){const e=t.color;h=new _e.Color(e[0],e[1],e[2])}Object.prototype.hasOwnProperty.call(t,"visibility")&&(p=n[e].visibility)}const m=new _e.MeshPhongMaterial({color:h,side:_e.DoubleSide,wireframe:!1,flatShading:!1,shininess:0}),u=new _e.BufferGeometry;u.setIndex(l),u.setAttribute("position",new _e.Float32BufferAttribute(r,3)),u.setAttribute("normal",new _e.Float32BufferAttribute(d,3)),u.computeBoundingBox(),r.length>0&&u.computeBoundsTree();const g=new _e.Mesh(u,m);g.name=e,g.visible=p,p&&this._boundingGroup.expandByObject(g),s.includes(e)&&(this._selectedMeshes.push(g),g.material.color=Te);const y=new _e.LineBasicMaterial({linewidth:5,color:Ee});i.forEach((e=>{const t=new _e.Float32BufferAttribute(e.vertexCoord,3),n=new _e.BufferGeometry;n.setAttribute("position",t);const s=new _e.Line(n,y);s.name="edge",g.add(s)})),this._meshGroup&&this._meshGroup.add(g)})),n&&(null===(t=this._model.sharedModel)||void 0===t||t.setOption("guidata",n)),null===this._refLength&&this._meshGroup.children.length){const e=new _e.Vector3;this._boundingGroup.getSize(e),this._refLength=Math.max(e.x,e.y,e.z)/5||1,this._updatePointers(this._refLength),this._camera.lookAt(this._scene.position),this._camera.position.set(10*this._refLength,10*this._refLength,10*this._refLength),this._camera.far=200*this._refLength}this._meshGroup.children.length||(this._refLength=null),this._setupExplodedView(),this._scene.add(this._meshGroup),this.setState((e=>Object.assign(Object.assign({},e),{loading:!1})))},this._postMessage=(e,t)=>{if(this._worker){const n=Object.assign(Object.assign({},e),{id:this.state.id});t?this._worker.postMessage(n,[t]):this._worker.postMessage(n)}},this._onSharedMetadataChanged=(e,t)=>{const n=Object.assign({},this.state.annotations);t.forEach(((e,t)=>{if(!t.startsWith("annotation"))return;const s=this._model.sharedModel.getMetadata(t);let o=!0;if(this.state.firstLoad&&(o=!1),!s||"add"!==e.action&&"update"!==e.action)"delete"===e.action&&delete n[t];else{const e=JSON.parse(s);e.open=o,n[t]=e}})),this.setState((e=>Object.assign(Object.assign({},e),{annotations:n,firstLoad:!1})))},this._onClientSharedStateChanged=(e,t)=>{var n,s,o,i,a;const r=null===(n=this._model.localState)||void 0===n?void 0:n.remoteUser;if(r){const e=t.get(r);if(!e)return;(null===(s=e.user)||void 0===s?void 0:s.username)!==(null===(o=this.state.remoteUser)||void 0===o?void 0:o.username)&&this.setState((t=>Object.assign(Object.assign({},t),{remoteUser:e.user}))),Array.isArray(e.selected.value)&&this._updateSelected(e.selected.value);const n=e.camera;if(null==n?void 0:n.value){const{position:e,rotation:t,up:s}=n.value;this._camera.position.set(e[0],e[1],e[2]),this._camera.rotation.set(t[0],t[1],t[2]),this._camera.up.set(s[0],s[1],s[2])}}else{if(null!==this.state.remoteUser){this.setState((e=>Object.assign(Object.assign({},e),{remoteUser:null})));const e=null===(a=null===(i=this._model.localState)||void 0===i?void 0:i.camera)||void 0===a?void 0:a.value;if(e){const t=e.position,n=e.rotation,s=e.up;this._camera.position.set(t[0],t[1],t[2]),this._camera.rotation.set(n[0],n[1],n[2]),this._camera.up.set(s[0],s[1],s[2])}}const e=this._model.localState;(null==e?void 0:e.selected)&&Array.isArray(e.selected.value)&&this._updateSelected(e.selected.value)}t.forEach(((e,t)=>{var n,s;const o=null===(n=e.pointer)||void 0===n?void 0:n.value;if(this._model.getClientId()===t)return;let i=this._collaboratorPointers[t];if(o){const n=null===(s=this._meshGroup)||void 0===s?void 0:s.getObjectByName(o.parent);if(!i){const s=this._createPointer(e.user);i=this._collaboratorPointers[t]={mesh:s,parent:n},this._scene.add(s)}if(i.mesh.visible=!0,this._explodedView.enabled){const e=this._computeExplodedState(n),t=e.vector.multiplyScalar(e.distance);i.mesh.position.copy(new _e.Vector3(o.x+t.x,o.y+t.y,o.z+t.z))}else i.mesh.position.copy(new _e.Vector3(o.x,o.y,o.z));i.parent=n}else this._collaboratorPointers[t]&&(this._collaboratorPointers[t].mesh.visible=!1)}))},this._handleThemeChange=()=>{const e="true"===document.body.getAttribute("data-jp-theme-light");Oe.set(U(Se)),Ee.set(U(Me)),Te.set(U(Ae)),this.setState((t=>Object.assign(Object.assign({},t),{lightTheme:e})))},this._handleWindowResize=()=>{this.resizeCanvasToDisplaySize(),this._updateAnnotation()},this.divRef=p.createRef(),this._worker=void 0,this._selectedMeshes=[],this._meshGroup=null,this._boundingGroup=new _e.Box3,this._explodedView={enabled:!1,factor:0},this._explodedViewLinesHelperGroup=null,this._cameraSettings={type:"Perspective"},this._raycaster=new _e.Raycaster,this._requestID=null,this._refLength=null,this._pointer3D=null,this._geometry=new _e.BufferGeometry,this._geometry.setDrawRange(0,3e4),this.props.view.changed.connect(this._onViewChanged,this);const t="true"===document.body.getAttribute("data-jp-theme-light");this.state={id:(0,u.v4)(),lightTheme:t,loading:!0,annotations:{},firstLoad:!0},this._model=this.props.jcadModel,this._worker=this._model.getWorker(),this._pointer=new _e.Vector2,this._collaboratorPointers={},this._messageChannel=new MessageChannel,this._messageChannel.port1.onmessage=e=>{this.messageHandler(e.data)},this._postMessage({action:ge.REGISTER,payload:{id:this.state.id}},this._messageChannel.port2),this._model.themeChanged.connect(this._handleThemeChange,this),this._model.sharedObjectsChanged.connect(this._onSharedObjectsChanged,this),this._model.sharedOptionsChanged.connect(this._onSharedOptionsChanged,this),this._model.clientStateChanged.connect(this._onClientSharedStateChanged,this),this._model.sharedMetadataChanged.connect(this._onSharedMetadataChanged,this),this._raycaster.params.Line&&(this._raycaster.params.Line.threshold=.1)}componentDidMount(){window.addEventListener("resize",this._handleWindowResize),this.generateScene(),this.addContextMenu()}componentDidUpdate(e,t){this.resizeCanvasToDisplaySize()}componentWillUnmount(){window.cancelAnimationFrame(this._requestID),window.removeEventListener("resize",this._handleWindowResize),this.props.view.changed.disconnect(this._onViewChanged,this),this._controls.dispose(),this._model.themeChanged.disconnect(this._handleThemeChange,this),this._model.sharedOptionsChanged.disconnect(this._onSharedOptionsChanged,this),this._model.sharedObjectsChanged.disconnect(this._onSharedObjectsChanged,this),this._model.clientStateChanged.disconnect(this._onClientSharedStateChanged,this),this._model.sharedMetadataChanged.disconnect(this._onSharedMetadataChanged,this)}_pick(){var e;if(null===this._meshGroup||!this._meshGroup.children)return null;this._raycaster.setFromCamera(this._pointer,this._camera);const t=this._raycaster.intersectObjects(this._meshGroup.children);if(t.length>0)for(const n of t)if(n.object.visible&&(null===(e=n.object.parent)||void 0===e?void 0:e.visible))return{mesh:n.object,position:n.point};return null}_updateAnnotation(){Object.keys(this.state.annotations).forEach((e=>{var t,n;const s=document.getElementById(e);if(s){const o=null===(t=this._model.annotationModel)||void 0===t?void 0:t.getAnnotation(e);let i=new _e.Vector2;if(o){const e=null===(n=this._meshGroup)||void 0===n?void 0:n.getObjectByName(o.parent),t=new _e.Vector3(o.position[0],o.position[1],o.position[2]);if(this._explodedView.enabled&&e){const n=this._computeExplodedState(e),s=n.vector.multiplyScalar(n.distance);t.add(s)}i=this._projectVector(t)}s.style.left=`${Math.round(i.x)}px`,s.style.top=`${Math.round(i.y)}px`}}))}_onPointerMove(e){const t=this._renderer.domElement.getBoundingClientRect();this._pointer.x=(e.clientX-t.left)/t.width*2-1,this._pointer.y=-(e.clientY-t.top)/t.height*2+1;const n=this._pick();if(!this._pointer3D&&this._model.localState&&n&&(this._pointer3D={parent:n.mesh,mesh:this._createPointer(this._model.localState.user)},this._scene.add(this._pointer3D.mesh)),n){if(!this._pointer3D)return void this._syncPointer(void 0,void 0);if(this._pointer3D.mesh.visible=!0,this._pointer3D.mesh.position.copy(n.position),this._pointer3D.parent=n.mesh,this._explodedView.enabled){const e=this._computeExplodedState(this._pointer3D.parent);n.position.add(e.vector.multiplyScalar(-e.distance))}this._syncPointer(n.position,n.mesh.name)}else this._pointer3D&&(this._pointer3D.mesh.visible=!1),this._syncPointer(void 0,void 0)}_onClick(e){const t=this._pick(),n=new Set(this._selectedMeshes.map((e=>e.name)));if(t){let s="";if(s=t.mesh.name.startsWith("edge")?t.mesh.parent.name:t.mesh.name,e.ctrlKey)n.has(s)?n.delete(s):n.add(s);else{const e=n.has(s);n.clear(),e||n.add(s)}const o=Array.from(n);this._updateSelected(o),this._model.syncSelectedObject(o,this.state.id)}}_updatePointers(e){this._pointerGeometry=new _e.SphereGeometry(e/10,32,32);for(const e in this._collaboratorPointers)this._collaboratorPointers[e].mesh.geometry=this._pointerGeometry}_createPointer(e){var t;let n=null;n=(null===(t=e.color)||void 0===t?void 0:t.startsWith("var"))?j.color(getComputedStyle(document.documentElement).getPropertyValue(e.color.slice(4,-1))):j.color(e.color);const s=new _e.MeshBasicMaterial({color:n?new _e.Color(n.r/255,n.g/255,n.b/255):"black"});return new _e.Mesh(this._pointerGeometry,s)}_updateSelected(e){var t;for(const e of this._selectedMeshes){let t=Oe;const n=this._model.sharedModel.getOption("guidata");if(n&&n[e.name]&&n[e.name].color){const s=n[e.name].color;t=new _e.Color(s[0],s[1],s[2])}e.material.color=t}this._selectedMeshes=[];for(const n of e){const e=null===(t=this._meshGroup)||void 0===t?void 0:t.getObjectByName(n);e&&(this._selectedMeshes.push(e),e.material.color=Te)}}_onSharedObjectsChanged(e,t){t.objectChange&&this._postMessage({action:ge.LOAD_FILE,payload:{content:this._model.getContent()}})}_onSharedOptionsChanged(e,t){var n,s;const o=e.getOption("guidata");if(o)for(const e in o){const t=null===(n=this._meshGroup)||void 0===n?void 0:n.getObjectByName(e);if(t){if(Object.prototype.hasOwnProperty.call(o[e],"visibility")){const n=null===(s=this._explodedViewLinesHelperGroup)||void 0===s?void 0:s.getObjectByName(e),i=o[e];i&&(t.visible=i.visibility,n&&(n.visible=i.visibility))}if("color"in o[e]){const n=o[e].color,s=new _e.Color(n[0],n[1],n[2]);t.material.color=s}else t.material.color=Oe}}}_onViewChanged(e,t){var n;if("axes"===t.key){null===(n=this._sceneAxe)||void 0===n||n.removeFromParent();const e=t.newValue;"remove"!==t.type&&e&&e.visible&&(this._sceneAxe=new _e.AxesHelper(e.size),this._scene.add(this._sceneAxe))}if("explodedView"===t.key){const e=t.newValue;"remove"!==t.type&&e&&(this._explodedView=e,this._setupExplodedView())}if("cameraSettings"===t.key){const e=t.newValue;"remove"!==t.type&&e&&(this._cameraSettings=e,this._updateCamera())}}_setupExplodedView(){var e,t,n,s;if(this._explodedView.enabled){const n=new _e.Vector3;this._boundingGroup.getCenter(n),null===(e=this._explodedViewLinesHelperGroup)||void 0===e||e.removeFromParent(),this._explodedViewLinesHelperGroup=new _e.Group;for(const e of null===(t=this._meshGroup)||void 0===t?void 0:t.children){const t=this._computeExplodedState(e);e.position.set(0,0,0),e.translateOnAxis(t.vector,t.distance);const n=new _e.LineBasicMaterial({color:Ee,linewidth:2}),s=(new _e.BufferGeometry).setFromPoints([t.oldGeometryCenter,t.newGeometryCenter]),o=new _e.Line(s,n);o.name=e.name,o.visible=e.visible,this._explodedViewLinesHelperGroup.add(o)}this._scene.add(this._explodedViewLinesHelperGroup)}else{for(const e of null===(n=this._meshGroup)||void 0===n?void 0:n.children)e.position.set(0,0,0);null===(s=this._explodedViewLinesHelperGroup)||void 0===s||s.removeFromParent()}}_updateCamera(){var e,t;const n=(new _e.Vector3).copy(this._camera.position),s=(new _e.Vector3).copy(this._camera.up);if(this._camera.remove(this._cameraLight),this._scene.remove(this._camera),"Perspective"===this._cameraSettings.type)this._camera=new _e.PerspectiveCamera(90,2,.1,1e3);else{const n=(null===(e=this.divRef.current)||void 0===e?void 0:e.clientWidth)||0,s=(null===(t=this.divRef.current)||void 0===t?void 0:t.clientHeight)||0;this._camera=new _e.OrthographicCamera(n/-2,n/2,s/2,s/-2)}this._camera.add(this._cameraLight),this._scene.add(this._camera),this._controls.object=this._camera,this._camera.position.copy(n),this._camera.up.copy(s)}_computeExplodedState(e){var t;const n=new _e.Vector3;this._boundingGroup.getCenter(n);const s=new _e.Vector3;null===(t=e.geometry.boundingBox)||void 0===t||t.getCenter(s);const o=new _e.Vector3(s.x-n.x,s.y-n.y,s.z-n.z),i=o.length()*this._explodedView.factor;return o.normalize(),{oldGeometryCenter:s,newGeometryCenter:new _e.Vector3(s.x+i*o.x,s.y+i*o.y,s.z+i*o.z),vector:o,distance:i}}render(){var e;return p.createElement("div",{className:"jcad-Mainview",style:{border:this.state.remoteUser?`solid 3px ${this.state.remoteUser.color}`:"unset"}},p.createElement("div",{className:"jpcad-Spinner",style:{display:this.state.loading?"flex":"none"}}," ",p.createElement("div",{className:"jpcad-SpinnerContent"})," "),(null===(e=this.state.remoteUser)||void 0===e?void 0:e.display_name)?p.createElement("div",{style:{position:"absolute",top:1,right:3,background:this.state.remoteUser.color}},`Following ${this.state.remoteUser.display_name}`):null,Object.entries(this.state.annotations).map((([e,t])=>{var n;if(!this._model.annotationModel)return null;const s=null===(n=this._meshGroup)||void 0===n?void 0:n.getObjectByName(t.parent),o=new _e.Vector3(t.position[0],t.position[1],t.position[2]);if(this._explodedView.enabled&&s){const e=this._computeExplodedState(s),t=e.vector.multiplyScalar(e.distance);o.add(t)}const i=this._projectVector(o);return p.createElement("div",{key:e,id:e,style:{left:i.x,top:i.y},className:"jcad-Annotation-Wrapper"},p.createElement(Pe,{itemId:e,model:this._model.annotationModel,open:!1}))})),p.createElement("div",{ref:this.divRef,style:{width:"100%",height:"calc(100%)"}}))}}class Le extends h.DocumentWidget{constructor(e){super(e),this.onResize=e=>{window.dispatchEvent(new Event("resize"))}}dispose(){this.content.dispose(),super.dispose()}}class Ne extends o.ReactWidget{constructor(e){super(),this.addClass("jp-jupytercad-panel"),this._jcadModel=e.model,this._view=new ve.ObservableMap}get viewChanged(){return this._view.changed}dispose(){this.isDisposed||(be.Signal.clearData(this),super.dispose())}get axes(){return this._view.get("axes")}set axes(e){this._view.set("axes",e||null)}get explodedView(){return this._view.get("explodedView")}set explodedView(e){this._view.set("explodedView",e||null)}get cameraSettings(){return this._view.get("cameraSettings")}set cameraSettings(e){this._view.set("cameraSettings",e||null)}deleteAxes(){this._view.delete("axes")}render(){return p.createElement(Ie,{view:this._view,jcadModel:this._jcadModel})}}class ke extends h.ABCWidgetFactory{constructor(e){const{backendCheck:t}=e;super(function(e,t){var n={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(n[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(s=Object.getOwnPropertySymbols(e);o<s.length;o++)t.indexOf(s[o])<0&&Object.prototype.propertyIsEnumerable.call(e,s[o])&&(n[s[o]]=e[s[o]])}return n}(e,["backendCheck"])),this._backendCheck=t,this._commands=e.commands}createNewWidget(e){if(this._backendCheck&&!this._backendCheck())throw new Error("Requested backend is not installed");const{model:t}=e,n=new Ne({model:t}),s=new ue({commands:this._commands,model:t});return new Le({context:e,content:n,toolbar:s})}}var Be=n(2293),De=n(7930),Fe=n(7991),Re=n.n(Fe),ze=n(981);const We=JSON.parse('{"type":"object","title":"IJCadContent","required":["objects"],"additionalProperties":false,"properties":{"objects":{"$ref":"#/definitions/jcadModel"},"options":{"$ref":"#/definitions/jcadOptions"},"metadata":{"type":"object","patternProperties":{"^.*$":{"type":"string"}},"additionalProperties":false}},"definitions":{"parts":{"type":"string","enum":["Part::Any","Part::Box","Part::Cylinder","Part::Sphere","Part::Cone","Part::Torus","Part::Cut","Part::MultiFuse","Part::MultiCommon","Part::Extrusion","Sketcher::SketchObject"]},"shapeMetadata":{"title":"IShapeMetadata","type":"object","required":["mass","centerOfMass","matrixOfInertia"],"additionalProperties":false,"properties":{"mass":{"type":"number"},"centerOfMass":{"type":"array","items":{"type":"number"}},"matrixOfInertia":{"type":"array","items":{"type":"array","items":{"type":"number"}}}}},"jcadObject":{"title":"IJCadObject","type":"object","additionalProperties":false,"required":["name","visible"],"properties":{"name":{"type":"string"},"visible":{"type":"boolean"},"shape":{"$ref":"#/definitions/parts"},"parameters":{"type":"object"},"shapeMetadata":{"$ref":"#/definitions/shapeMetadata"},"operators":{"type":"array","items":{"type":"object"}},"dependencies":{"type":"array","items":{"type":"string"}}}},"jcadModel":{"title":"IJCadModel","type":"array","default":[],"items":{"$ref":"#/definitions/jcadObject"}},"jcadOptions":{"title":"IJCadOptions","type":"object","default":{},"additionalProperties":false,"properties":{"guidata":{"type":"object"}}}}}');class Ve{constructor(e){this.collaborative=!0,this._onClientStateChanged=e=>{const t=this.sharedModel.awareness.getStates();this._clientStateChanged.emit(t),this._sharedModel.awareness.on("change",(e=>{(e.added.length||e.removed.length)&&this._userChanged.emit(this.users)}))},this.defaultKernelName="",this.defaultKernelLanguage="",this._dirty=!1,this._readOnly=!1,this._isDisposed=!1,this._userChanged=new be.Signal(this),this._disposed=new be.Signal(this),this._contentChanged=new be.Signal(this),this._stateChanged=new be.Signal(this),this._themeChanged=new be.Signal(this),this._clientStateChanged=new be.Signal(this);const{annotationModel:t,sharedModel:n}=e;this._sharedModel=n||Ge.create(),this.sharedModel.awareness.on("change",this._onClientStateChanged),this.annotationModel=t}get sharedModel(){return this._sharedModel}get isDisposed(){return this._isDisposed}get contentChanged(){return this._contentChanged}get stateChanged(){return this._stateChanged}get themeChanged(){return this._themeChanged}get currentUserId(){var e;return null===(e=this.sharedModel)||void 0===e?void 0:e.awareness.clientID}get users(){var e;this._usersMap=null===(e=this._sharedModel)||void 0===e?void 0:e.awareness.getStates();const t=[];return this._usersMap&&this._usersMap.forEach(((e,n)=>{t.push({userId:n,userData:e.user})})),t}get userChanged(){return this._userChanged}get dirty(){return this._dirty}set dirty(e){this._dirty=e}get readOnly(){return this._readOnly}set readOnly(e){this._readOnly=e}get localState(){return this.sharedModel.awareness.getLocalState()}get clientStateChanged(){return this._clientStateChanged}get sharedMetadataChanged(){return this.sharedModel.metadataChanged}get sharedOptionsChanged(){return this.sharedModel.optionsChanged}get sharedObjectsChanged(){return this.sharedModel.objectsChanged}get disposed(){return this._disposed}dispose(){this._isDisposed||(this._isDisposed=!0,this._sharedModel.dispose(),this._disposed.emit(),be.Signal.clearData(this))}toString(){return JSON.stringify(this.getContent(),null,2)}fromString(e){const t=JSON.parse(e);if(!(new(Re())).compile(We)(t))throw Error("File format error");this.sharedModel.transact((()=>{var e;this.sharedModel.addObjects(t.objects),this.sharedModel.setOptions(null!==(e=t.options)&&void 0!==e?e:{})}))}toJSON(){return JSON.parse(this.toString())}fromJSON(e){}initialize(){}getWorker(){return Ve.worker||(Ve.worker=new Worker(new URL(n.p+n.u(268),n.b))),Ve.worker}getContent(){return{objects:this.sharedModel.objects,options:this.sharedModel.options}}getAllObject(){return this.sharedModel.objects}syncPointer(e,t){this.sharedModel.awareness.setLocalStateField("pointer",{value:e,emitter:t})}syncCamera(e,t){this.sharedModel.awareness.setLocalStateField("camera",{value:e,emitter:t})}syncSelectedObject(e,t){this.sharedModel.awareness.setLocalStateField("selected",{value:e,emitter:t})}syncSelectedPropField(e){this.sharedModel.awareness.setLocalStateField("selectedPropField",e)}setUserToFollow(e){this._sharedModel&&this._sharedModel.awareness.setLocalStateField("remoteUser",e)}syncFormData(e){this._sharedModel&&this._sharedModel.awareness.setLocalStateField("toolbarForm",e)}getClientId(){return this.sharedModel.awareness.clientID}addMetadata(e,t){this.sharedModel.setMetadata(e,t)}removeMetadata(e){this.sharedModel.removeMetadata(e)}}class Ge extends Be.YDocument{constructor(){super(),this._objectsObserver=e=>{const t=[];let n=!1;e.forEach((e=>{const s=e.target.get("name");s&&e.keys.forEach(((o,i)=>{n||"shapeMetadata"===i||(n=!0),t.push({name:s,key:i,newValue:De.JSONExt.deepCopy(e.target.toJSON())})}))})),n=0===t.length||n,n&&this._objectsChanged.emit({objectChange:t}),this._changed.emit({objectChange:t})},this._metaObserver=e=>{this._metadataChanged.emit(e.keys)},this._optionsObserver=e=>{this._optionsChanged.emit(e.keys)},this._metadataChanged=new be.Signal(this),this._optionsChanged=new be.Signal(this),this._objectsChanged=new be.Signal(this),this._options=this.ydoc.getMap("options"),this._objects=this.ydoc.getArray("objects"),this._metadata=this.ydoc.getMap("metadata"),this.undoManager.addToScope(this._objects),this._objects.observeDeep(this._objectsObserver),this._metadata.observe(this._metaObserver),this._options.observe(this._optionsObserver)}dispose(){this._objects.unobserveDeep(this._objectsObserver),this._metadata.unobserve(this._metaObserver),this._options.unobserve(this._optionsObserver),super.dispose()}get version(){return"0.1.0"}get objects(){return this._objects.map((e=>De.JSONExt.deepCopy(e.toJSON())))}get options(){return De.JSONExt.deepCopy(this._options.toJSON())}get metadata(){return De.JSONExt.deepCopy(this._metadata.toJSON())}get objectsChanged(){return this._objectsChanged}get optionsChanged(){return this._optionsChanged}get metadataChanged(){return this._metadataChanged}objectExists(e){return Boolean(this._getObjectAsYMapByName(e))}getObjectByName(e){const t=this._getObjectAsYMapByName(e);if(t)return De.JSONExt.deepCopy(t.toJSON())}removeObjectByName(e){let t=0;for(const n of this._objects){if(n.get("name")===e)break;t++}this._objects.length>t&&this.transact((()=>{this._objects.delete(t);const n=this.getOption("guidata");n&&(delete n[e],this.setOption("guidata",n))}))}addObject(e){this.addObjects([e])}addObjects(e){this.transact((()=>{e.map((e=>{this.objectExists(e.name)?console.error("There is already an object with the name:",e.name):this._objects.push([new ze.Map(Object.entries(e))])}))}))}updateObjectByName(e,t,n){const s=this._getObjectAsYMapByName(e);s&&this.transact((()=>s.set(t,n)))}getOption(e){const t=this._options.get(e);if(t)return De.JSONExt.deepCopy(t)}setOption(e,t){this.transact((()=>{this._options.set(e,t)}))}setOptions(e){this.transact((()=>{for(const[t,n]of Object.entries(e))this._options.set(t,n)}))}getMetadata(e){return this._metadata.get(e)}setMetadata(e,t){this.transact((()=>{this._metadata.set(e,t)}))}removeMetadata(e){this._metadata.has(e)&&this._metadata.delete(e)}setShapeMeta(e,t){const n=this._getObjectAsYMapByName(e);t&&n&&this.transact((()=>{n.set("shapeMetadata",t)}))}static create(){return new Ge}_getObjectAsYMapByName(e){for(const t of this._objects)if(t.get("name")===e)return t}}const Ze=new De.Token("jupyterCadDocTracker"),Ue=new De.Token("jupytercadAnnotationModel");class Ye{constructor(e){this.collaborative=!0,this._disposed=!1,this._annotationModel=e.annotationModel}get name(){return"jupytercad-fcmodel"}get contentType(){return"FCStd"}get fileFormat(){return"base64"}get isDisposed(){return this._disposed}dispose(){this._disposed=!0}preferredLanguage(e){return""}createNew(e){return new Ve({sharedModel:e.sharedModel,languagePreference:e.languagePreference,annotationModel:this._annotationModel})}}const Je="Jupytercad Freecad Factory";var qe;!function(e){e.createNew="jupytercad:create-new-FCStd-file"}(qe||(qe={}));const Xe={id:"jupytercad:fcplugin",requires:[Ze,o.IThemeManager,Ue,d.IFileBrowserFactory,r.ICollaborativeDrive],optional:[l.ILauncher,o.ICommandPalette],autoStart:!0,activate:async(e,t,n,s,i,a,r,d)=>{const l=await async function(e="",t={}){const n=C.ServerConnection.makeSettings(),s=x.URLExt.join(n.baseUrl,e);let o;try{o=await C.ServerConnection.makeRequest(s,t,n)}catch(e){throw new C.ServerConnection.NetworkError(e)}let i=await o.text();if(i.length>0)try{i=JSON.parse(i)}catch(e){console.log("Not a JSON response body.",o)}if(!o.ok)throw new C.ServerConnection.ResponseError(o,i.message||i);return i}("cad/backend-check",{method:"POST",body:JSON.stringify({backend:"FreeCAD"})}),{installed:h}=l,p=new ke({name:Je,modelName:"jupytercad-fcmodel",fileTypes:["FCStd"],defaultFor:["FCStd"],tracker:t,commands:e.commands,backendCheck:()=>(h||(0,o.showErrorMessage)("FreeCAD is not installed","FreeCAD is required to open FCStd files"),h)});e.docRegistry.addWidgetFactory(p);const m=new Ye({annotationModel:s});e.docRegistry.addModelFactory(m),e.docRegistry.addFileType({name:"FCStd",displayName:"FCStd",mimeTypes:["application/octet-stream"],extensions:[".FCStd","fcstd"],fileFormat:"base64",contentType:"FCStd"}),a.sharedModelFactory.registerDocumentFactory("FCStd",(()=>new Ge)),p.widgetCreated.connect(((s,o)=>{o.context.pathChanged.connect((()=>{t.save(o)})),n.themeChanged.connect(((e,t)=>o.context.model.themeChanged.emit(t))),t.add(o),e.shell.activateById("jupytercad::leftControlPanel"),e.shell.activateById("jupytercad::rightControlPanel")})),e.commands.addCommand(qe.createNew,{label:e=>e.isPalette?"New FCStd Editor":"FCStd Editor",caption:"Create a new FCStd Editor",icon:e=>e.isPalette?void 0:c.fileIcon,execute:async t=>{var n;const s=t.cwd||(null===(n=i.tracker.currentWidget)||void 0===n?void 0:n.model.path);let o=await e.serviceManager.contents.newUntitled({path:s,type:"file",ext:".FCStd"});return console.debug("Model:",o),o=await e.serviceManager.contents.save(o.path,Object.assign(Object.assign({},o),{format:"base64",size:void 0,content:btoa("")})),e.commands.execute("docmanager:open",{path:o.path,factory:Je})}})}};class He{constructor(e){this.collaborative=!0,this._disposed=!1,this._annotationModel=e.annotationModel}get name(){return"jupytercad-jcadmodel"}get contentType(){return"jcad"}get fileFormat(){return"text"}get isDisposed(){return this._disposed}dispose(){this._disposed=!0}preferredLanguage(e){return""}createNew(e){return new Ve({sharedModel:e.sharedModel,languagePreference:e.languagePreference,annotationModel:this._annotationModel})}}const $e="Jupytercad Jcad Factory";var Ke;!function(e){e.createNew="jupytercad:create-new-jcad-file"}(Ke||(Ke={}));const Qe={id:"jupytercad:jcadplugin",requires:[Ze,o.IThemeManager,Ue,d.IFileBrowserFactory,r.ICollaborativeDrive],optional:[l.ILauncher,o.ICommandPalette],autoStart:!0,activate:(e,t,n,s,o,i,a,r)=>{const d=new ke({name:$e,modelName:"jupytercad-jcadmodel",fileTypes:["jcad"],defaultFor:["jcad"],tracker:t,commands:e.commands});e.docRegistry.addWidgetFactory(d);const l=new He({annotationModel:s});e.docRegistry.addModelFactory(l),e.docRegistry.addFileType({name:"jcad",displayName:"JCAD",mimeTypes:["text/json"],extensions:[".jcad",".JCAD"],fileFormat:"text",contentType:"jcad"}),i.sharedModelFactory.registerDocumentFactory("jcad",(()=>new Ge)),d.widgetCreated.connect(((s,o)=>{o.context.pathChanged.connect((()=>{t.save(o)})),n.themeChanged.connect(((e,t)=>o.context.model.themeChanged.emit(t))),t.add(o),e.shell.activateById("jupytercad::leftControlPanel"),e.shell.activateById("jupytercad::rightControlPanel")})),e.commands.addCommand(Ke.createNew,{label:e=>"New JCAD File",caption:"Create a new JCAD Editor",icon:e=>e.isPalette?void 0:c.fileIcon,execute:async t=>{var n;const s=t.cwd||(null===(n=o.tracker.currentWidget)||void 0===n?void 0:n.model.path);let i=await e.serviceManager.contents.newUntitled({path:s,type:"file",ext:".jcad"});return console.debug("Model:",i),i=await e.serviceManager.contents.save(i.path,Object.assign(Object.assign({},i),{format:"text",size:void 0,content:'{\n\t"objects": [],\n\t"options": {},\n\t"metadata": {}\n}'})),e.commands.execute("docmanager:open",{path:i.path,factory:$e})}}),a&&a.add({command:Ke.createNew,category:"Other",rank:1}),r&&r.addItem({command:Ke.createNew,args:{isPalette:!0},category:"JupyterCAD"})}};class et{constructor(e){this._tracker=e.tracker,this._documentChanged=this._tracker.currentChanged}get documentChanged(){return this._documentChanged}get filePath(){var e;return null===(e=this._tracker.currentWidget)||void 0===e?void 0:e.context.localPath}get jcadModel(){var e;return null===(e=this._tracker.currentWidget)||void 0===e?void 0:e.context.model}get sharedModel(){var e;return null===(e=this._tracker.currentWidget)||void 0===e?void 0:e.context.model.sharedModel}disconnect(e){this._tracker.forEach((t=>{t.context.model.sharedObjectsChanged.disconnect(e),t.context.model.sharedOptionsChanged.disconnect(e),t.context.model.sharedMetadataChanged.disconnect(e)})),this._tracker.forEach((t=>t.context.model.themeChanged.disconnect(e))),this._tracker.forEach((t=>t.context.model.clientStateChanged.disconnect(e)))}}class tt extends m.Widget{constructor(){super({node:nt()}),this.title.changed.connect((e=>{this.node.textContent=this.title.label}))}}function nt(){const e=document.createElement("h2");return e.textContent="-",e}var st=n(8743);const ot=new c.LabIcon({name:"jupytercad:visibilityIcon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24">\n    <path d="M0 0h24v24H0V0z" fill="none" />\n    <path class="jp-icon3" d="M12 6c3.79 0 7.17 2.13 8.82 5.5C19.17 14.87 15.79 17 12 17s-7.17-2.13-8.82-5.5C4.83 8.13 8.21 6 12 6m0-2C7 4 2.73 7.11 1 11.5 2.73 15.89 7 19 12 19s9.27-3.11 11-7.5C21.27 7.11 17 4 12 4zm0 5c1.38 0 2.5 1.12 2.5 2.5S13.38 14 12 14s-2.5-1.12-2.5-2.5S10.62 9 12 9m0-2c-2.48 0-4.5 2.02-4.5 4.5S9.52 16 12 16s4.5-2.02 4.5-4.5S14.48 7 12 7z" fill="none" />\n</svg>\n'}),it=new c.LabIcon({name:"jupytercad:visibilityOffIcon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24">\n    <path d="M0 0h24v24H0V0zm0 0h24v24H0V0zm0 0h24v24H0V0zm0 0h24v24H0V0z" fill="none" />\n    <path class="jp-icon3" d="M12 6c3.79 0 7.17 2.13 8.82 5.5-.59 1.22-1.42 2.27-2.41 3.12l1.41 1.41c1.39-1.23 2.49-2.77 3.18-4.53C21.27 7.11 17 4 12 4c-1.27 0-2.49.2-3.64.57l1.65 1.65C10.66 6.09 11.32 6 12 6zm-1.07 1.14L13 9.21c.57.25 1.03.71 1.28 1.28l2.07 2.07c.08-.34.14-.7.14-1.07C16.5 9.01 14.48 7 12 7c-.37 0-.72.05-1.07.14zM2.01 3.87l2.68 2.68C3.06 7.83 1.77 9.53 1 11.5 2.73 15.89 7 19 12 19c1.52 0 2.98-.29 4.32-.82l3.42 3.42 1.41-1.41L3.42 2.45 2.01 3.87zm7.5 7.5l2.61 2.61c-.04.01-.08.02-.12.02-1.38 0-2.5-1.12-2.5-2.5 0-.05.01-.08.01-.13zm-3.4-3.4l1.75 1.75c-.23.55-.36 1.15-.36 1.78 0 2.48 2.02 4.5 4.5 4.5.63 0 1.23-.13 1.77-.36l.98.98c-.88.24-1.8.38-2.75.38-3.79 0-7.17-2.13-8.82-5.5.7-1.43 1.72-2.61 2.93-3.53z" fill="none" />\n</svg>\n'}),at={labTheme:{text:{fontSize:"14px",fontFamily:"var(--jp-ui-font-family)",color:"var(--jp-ui-font-color1)",selectedColor:"var(--jp-ui-inverse-font-color1)",hoverColor:"var(--jp-ui-font-color2)"},nodes:{folder:{bgColor:"var(--jp-layout-color1)",selectedBgColor:"var(--jp-layout-color2)",hoverBgColor:"var(--jp-layout-color2)"},leaf:{bgColor:"var(--jp-layout-color1)",selectedBgColor:"var(--jp-layout-color2)",hoverBgColor:"var(--jp-layout-color2)"},icons:{size:"9px",folderColor:"var(--jp-inverse-layout-color3)",leafColor:"var(--jp-inverse-layout-color3)"}}}};class rt extends c.PanelWithToolbar{constructor(e){super(e),this.title.label="Objects tree";const t=o.ReactWidget.create(p.createElement(dt,{cpModel:e.controlPanelModel}));this.addWidget(t),this.addClass("jpcad-sidebar-treepanel")}}class dt extends p.Component{constructor(e){var t,n;super(e),this.stateToTree=()=>this.state.jcadObject?this.state.jcadObject.map((e=>{var t;const n=e.name,s=[];return e.shape&&s.push({id:`${n}#shape#${e.shape}#${this.state.filePath}`,label:"Shape",parentId:n}),e.operators&&s.push({id:`${n}#operator#${this.state.filePath}`,label:"Operators",parentId:n}),{id:n,label:null!==(t=e.name)&&void 0!==t?t:`Object (#${n})`,parentId:null,items:s}})):[],this._handleThemeChange=()=>{const e="true"===document.body.getAttribute("data-jp-theme-light");this.setState((t=>Object.assign(Object.assign({},t),{lightTheme:e})))},this._sharedJcadModelChanged=(e,t)=>{t.objectChange&&this.setState((e=>{var t,n;return Object.assign(Object.assign({},e),{jcadObject:null===(t=this.props.cpModel.jcadModel)||void 0===t?void 0:t.getAllObject(),options:null===(n=this.props.cpModel.sharedModel)||void 0===n?void 0:n.options})}))},this._onClientSharedStateChanged=(e,t)=>{var n,s,o;const i=null===(n=this.props.cpModel.jcadModel)||void 0===n?void 0:n.localState;if(!i)return;let a=[];if(i.remoteUser){const e=t.get(i.remoteUser);(null===(s=null==e?void 0:e.selected)||void 0===s?void 0:s.value)&&(a=e.selected.value)}else(null===(o=i.selected)||void 0===o?void 0:o.value)&&(a=i.selected.value);const r=[...this.state.openNodes];for(const e of a)e&&-1===r.indexOf(e)&&r.push(e);this.setState((e=>Object.assign(Object.assign({},e),{openNodes:r,selectedNodes:a})))},this._onClientSharedOptionsChanged=(e,t)=>{this.setState((t=>Object.assign(Object.assign({},t),{options:e.options})))};const s="true"===document.body.getAttribute("data-jp-theme-light");this.state={filePath:this.props.cpModel.filePath,jcadObject:null===(t=this.props.cpModel.jcadModel)||void 0===t?void 0:t.getAllObject(),lightTheme:s,selectedNodes:[],clientId:null,id:(0,u.v4)(),openNodes:[]},null===(n=this.props.cpModel.jcadModel)||void 0===n||n.sharedObjectsChanged.connect(this._sharedJcadModelChanged),this.props.cpModel.documentChanged.connect(((e,t)=>{t?(this.props.cpModel.disconnect(this._sharedJcadModelChanged),this.props.cpModel.disconnect(this._handleThemeChange),this.props.cpModel.disconnect(this._onClientSharedStateChanged),t.context.model.sharedObjectsChanged.connect(this._sharedJcadModelChanged),t.context.model.themeChanged.connect(this._handleThemeChange),t.context.model.clientStateChanged.connect(this._onClientSharedStateChanged),t.context.model.sharedOptionsChanged.connect(this._onClientSharedOptionsChanged),this.setState((e=>{var n,s;return Object.assign(Object.assign({},e),{filePath:t.context.localPath,jcadObject:null===(n=this.props.cpModel.jcadModel)||void 0===n?void 0:n.getAllObject(),options:null===(s=this.props.cpModel.sharedModel)||void 0===s?void 0:s.options,clientId:t.context.model.getClientId()})}))):this.setState({filePath:void 0,jcadObject:void 0,jcadOption:void 0})}))}getObjectFromName(e){if(e&&this.state.jcadObject){const t=this.state.jcadObject.filter((t=>t.name===e));if(t.length>0)return t[0]}}render(){const{selectedNodes:e,openNodes:t,options:n}=this.state,s=this.stateToTree(),o=[];for(const t of e){const e=s.filter((e=>e.id===t));e.length>0&&e[0].items.length>0&&o.push(e[0].items[0].id)}return p.createElement("div",{className:"jpcad-treeview-wrapper"},p.createElement(st.ReactTree,{multiSelect:!0,nodes:s,openNodes:t,selectedNodes:o,messages:{noData:"No data"},theme:"labTheme",themes:at,onToggleSelectedNodes:e=>{var t,n;if(e!==o)if(e&&e.length>0){const n=[];for(const t of e){const e=t;e.includes("#")?n.push(e.split("#")[0]):n.push(e)}null===(t=this.props.cpModel.jcadModel)||void 0===t||t.syncSelectedObject(n,this.state.id)}else null===(n=this.props.cpModel.jcadModel)||void 0===n||n.syncSelectedObject([])},RenderNode:e=>{const t=this.getObjectFromName(e.node.parentId);let s=!0;return t&&(s=t.visible),t&&n&&n.guidata&&Object.prototype.hasOwnProperty.call(n.guidata,t.name)&&Object.prototype.hasOwnProperty.call(n.guidata[t.name],"visibility")&&(s=n.guidata[t.name].visibility),p.createElement("div",{className:"jpcad-control-panel-tree "+(e.selected?"selected":"")},p.createElement("div",{style:{paddingLeft:"5px",minHeight:"20px",display:"flex",alignItems:"center",justifyContent:"space-between",minWidth:0}},p.createElement("span",{style:{whiteSpace:"nowrap",textOverflow:"ellipsis",overflowX:"hidden"}},e.node.label),"leaf"===e.type?p.createElement("div",{style:{display:"flex"}},p.createElement(c.ToolbarButtonComponent,{className:"jp-ToolbarButtonComponent",onClick:()=>{var t,n;const o=e.node.parentId,i=(null===(t=this.props.cpModel.sharedModel)||void 0===t?void 0:t.getOption("guidata"))||{objectId:{}};i&&(i[o]?i[o].visibility=!s:i[o]={visibility:!s}),null===(n=this.props.cpModel.sharedModel)||void 0===n||n.setOption("guidata",i)},icon:s?ot:it}),p.createElement(c.ToolbarButtonComponent,{className:"jp-ToolbarButtonComponent",onClick:()=>{var t,n;const s=e.node.parentId;null===(t=this.props.cpModel.jcadModel)||void 0===t||t.sharedModel.removeObjectByName(s),null===(n=this.props.cpModel.jcadModel)||void 0===n||n.syncSelectedObject([])},icon:c.closeIcon})):null))}}))}}class lt extends p.Component{constructor(e){super(e);const t=()=>{this.forceUpdate()};this._model=e.model,this._model.contextChanged.connect((async()=>{var n,s,o,i,a,r,d,l;await(null===(s=null===(n=this._model)||void 0===n?void 0:n.context)||void 0===s?void 0:s.ready),null===(a=null===(i=null===(o=this._model)||void 0===o?void 0:o.context)||void 0===i?void 0:i.model)||void 0===a||a.sharedMetadataChanged.disconnect(t),this._model=e.model,null===(l=null===(d=null===(r=this._model)||void 0===r?void 0:r.context)||void 0===d?void 0:d.model)||void 0===l||l.sharedMetadataChanged.connect(t),this.forceUpdate()}))}render(){var e;const t=null===(e=this._model)||void 0===e?void 0:e.getAnnotationIds();if(!t||!this._model)return p.createElement("div",null);const n=t.map((e=>p.createElement("div",null,p.createElement(je,{model:this._model,itemId:e}),p.createElement("hr",{className:"jpcad-Annotations-Separator"}))));return p.createElement("div",null,n)}}class ct extends c.PanelWithToolbar{constructor(e){super({}),this.title.label="Annotations",this.addClass("jpcad-Annotations"),this._model=e.model,this._widget=c.ReactWidget.create(p.createElement(lt,{model:this._model})),this.addWidget(this._widget)}}class ht extends c.SidePanel{constructor(e){super(),this.addClass("jpcad-sidepanel-widget"),this._model=e.model,this._annotationModel=e.annotationModel;const t=new tt;this.header.addWidget(t);const n=new rt({controlPanelModel:this._model});this.addWidget(n);const s=new ct({model:this._annotationModel});this.addWidget(s),e.tracker.currentChanged.connect(((n,s)=>{var o;s?(t.title.label=s.context.localPath,this._annotationModel.context=(null===(o=e.tracker.currentWidget)||void 0===o?void 0:o.context)||void 0):(t.title.label="-",this._annotationModel.context=void 0)}))}dispose(){super.dispose()}}class pt extends c.PanelWithToolbar{constructor(e){super(e),this.title.label="Objects Properties";const t=o.ReactWidget.create(p.createElement(mt,{cpModel:e.controlPanelModel}));this.addWidget(t),this.addClass("jpcad-sidebar-propertiespanel")}}class mt extends p.Component{constructor(e){var t,n;super(e),this.syncSelectedField=(e,t,n)=>{var s;let o=null;if(e){const t=e.split("_")[0];o=e.substring(t.length)}null===(s=this.props.cpModel.jcadModel)||void 0===s||s.syncSelectedPropField({parentType:n,id:o,value:t})},this._sharedJcadModelChanged=(e,t)=>{this.setState((e=>{var t,n;if(e.selectedObject){const n=null===(t=this.props.cpModel.jcadModel)||void 0===t?void 0:t.getAllObject();if(n){const t=z(e.selectedObject,n);if(!t)return e;const s=t.parameters;return Object.assign(Object.assign({},e),{jcadObject:n,selectedObjectData:s})}return e}return Object.assign(Object.assign({},e),{jcadObject:null===(n=this.props.cpModel.jcadModel)||void 0===n?void 0:n.getAllObject()})}))},this._onClientSharedStateChanged=(e,t)=>{var n,s,o,i,a,r,d,l,c;const h=null===(s=null===(n=this.props.cpModel.jcadModel)||void 0===n?void 0:n.localState)||void 0===s?void 0:s.remoteUser,p=this.state.clientId;let m;if(h){m=t.get(h);const e=null===(o=null==m?void 0:m.selectedPropField)||void 0===o?void 0:o.id,n=null===(i=null==m?void 0:m.selectedPropField)||void 0===i?void 0:i.value;"panel"===(null===(a=null==m?void 0:m.selectedPropField)||void 0===a?void 0:a.parentType)&&(this._lastSelectedPropFieldId=W(`${this.state.filePath}::panel`,e,n,null===(r=null==m?void 0:m.user)||void 0===r?void 0:r.color,this._lastSelectedPropFieldId))}else{const e=p?t.get(p):null;this._lastSelectedPropFieldId&&(G(`${this.state.filePath}::panel`,this._lastSelectedPropFieldId,["border-color","box-shadow"]),this._lastSelectedPropFieldId=void 0),e&&(null===(d=e.selected)||void 0===d?void 0:d.emitter)&&e.selected.emitter!==this.state.id&&(null===(l=e.selected)||void 0===l?void 0:l.value)&&(m=e)}if(m){const e=""+m.selected.value;if(e!==this.state.selectedObject){if(0===e.length)return void this.setState((e=>Object.assign(Object.assign({},e),{schema:void 0,selectedObjectData:void 0})));const t=null===(c=this.props.cpModel.jcadModel)||void 0===c?void 0:c.getAllObject();if(t){let n;const s=z(e,t);if(!s)return;s.shape&&(n=ee[s.shape]);const o=s.parameters;this.setState((t=>Object.assign(Object.assign({},t),{selectedObjectData:o,selectedObject:e,schema:n})))}}}},this.state={filePath:this.props.cpModel.filePath,jcadObject:null===(t=this.props.cpModel.jcadModel)||void 0===t?void 0:t.getAllObject(),clientId:null,id:(0,u.v4)()},null===(n=this.props.cpModel.jcadModel)||void 0===n||n.sharedObjectsChanged.connect(this._sharedJcadModelChanged),this.props.cpModel.documentChanged.connect(((e,t)=>{t?(this.props.cpModel.disconnect(this._sharedJcadModelChanged),this.props.cpModel.disconnect(this._onClientSharedStateChanged),t.context.model.sharedObjectsChanged.connect(this._sharedJcadModelChanged),t.context.model.clientStateChanged.connect(this._onClientSharedStateChanged),this.setState((e=>{var n;return Object.assign(Object.assign({},e),{filePath:t.context.localPath,jcadObject:null===(n=this.props.cpModel.jcadModel)||void 0===n?void 0:n.getAllObject(),clientId:t.context.model.getClientId()})}))):this.setState({jcadOption:void 0,filePath:void 0,jcadObject:void 0,selectedObjectData:void 0,selectedObject:void 0,schema:void 0})}))}syncObjectProperties(e,t){var n;if(!this.state.jcadObject||!e)return;const s=null===(n=this.props.cpModel.jcadModel)||void 0===n?void 0:n.sharedModel,o=null==s?void 0:s.getObjectByName(e);s&&o&&s.updateObjectByName(e,"parameters",Object.assign(Object.assign({},o.parameters),t))}render(){return this.state.schema&&this.state.selectedObjectData?p.createElement(K,{parentType:"panel",filePath:`${this.state.filePath}::panel`,schema:this.state.schema,sourceData:this.state.selectedObjectData,syncData:e=>{this.syncObjectProperties(this.state.selectedObject,e)},syncSelectedField:this.syncSelectedField}):p.createElement("div",null)}}class ut extends c.SidePanel{constructor(e){super(),this.addClass("jpcad-sidepanel-widget"),this._model=e.model;const t=new tt;this.header.addWidget(t);const n=new pt({controlPanelModel:this._model});this.addWidget(n),this._model.documentChanged.connect(((e,n)=>{t.title.label=n?n.context.localPath:"-"}))}dispose(){super.dispose()}}class gt{constructor(e){this._contextChanged=new be.Signal(this),this._updateSignal=new be.Signal(this),this.context=e.context}get updateSignal(){return this._updateSignal}get user(){return this._user}set context(e){var t;this._context=e;const n=null===(t=this._context)||void 0===t?void 0:t.model.sharedModel.awareness.getLocalState();this._user=null==n?void 0:n.user,this._contextChanged.emit(void 0)}get context(){return this._context}get contextChanged(){return this._contextChanged}update(){this._updateSignal.emit(null)}getAnnotation(e){var t;const n=null===(t=this._context)||void 0===t?void 0:t.model.sharedModel.getMetadata(e);if(n)return JSON.parse(n)}getAnnotationIds(){var e;const t=[];for(const n in null===(e=this._context)||void 0===e?void 0:e.model.sharedModel.metadata)n.startsWith("annotation")&&t.push(n);return t}addAnnotation(e,t){var n;null===(n=this._context)||void 0===n||n.model.sharedModel.setMetadata(`annotation_${e}`,JSON.stringify(t))}removeAnnotation(e){var t;null===(t=this._context)||void 0===t||t.model.removeMetadata(e)}addContent(e,t){var n;const s={value:t,user:this._user},o=this.getAnnotation(e);if(o){const t=Object.assign(Object.assign({},o),{contents:[...o.contents,s]});null===(n=this._context)||void 0===n||n.model.sharedModel.setMetadata(e,JSON.stringify(t))}}}var yt=n(8844);class vt extends yt.JupyterYModel{}class bt extends m.Panel{constructor(e){super(),this.onResize=()=>{this._jcadWidget&&H.MessageLoop.sendMessage(this._jcadWidget,m.Widget.ResizeMessage.UnknownSize)},this.addClass("jupytercad-notebook-widget"),this._jcadWidget=new Ne({model:e}),this.addWidget(this._jcadWidget)}}class ft{constructor(e,t){this.yModel=e,this.node=t;const n=new bt(e.jupyterCADModel);H.MessageLoop.sendMessage(n,m.Widget.Msg.BeforeAttach),t.appendChild(n.node),H.MessageLoop.sendMessage(n,m.Widget.Msg.AfterAttach)}}const _t={id:"jupytercad:yjswidget-plugin",autoStart:!0,requires:[i.ITranslator],optional:[yt.IJupyterYWidgetManager],activate:(e,t,n)=>{n?n.registerWidget("@jupytercad:widget",class extends vt{ydocFactory(n){const{path:s,format:o,contentType:i}=n;this.jupyterCADModel=new Ve({});const a=e.serviceManager.user;if(s&&o&&i){const e=C.ServerConnection.makeSettings(),n=x.URLExt.join(e.wsUrl,"api/collaboration/room"),d=new r.WebSocketProvider({url:n,path:s,format:o,contentType:i,model:this.jupyterCADModel.sharedModel,user:a,translator:t.load("jupyterlab")});this.jupyterCADModel.disposed.connect((()=>{d.dispose()}))}else{const e=this.jupyterCADModel.sharedModel.awareness,t=t=>{e.setLocalStateField("user",t.identity)};a.ready.then((()=>{t(a)})).catch((e=>console.error(e))),a.userChanged.connect(t,this)}return this.jupyterCADModel.sharedModel.ydoc}},ft):console.error("Missing IJupyterYWidgetManager token!")}},wt="jupytercad",xt={id:"jupytercad:annotation",autoStart:!0,requires:[Ze],provides:Ue,activate:(e,t)=>{var n;const s=new gt({context:null===(n=t.currentWidget)||void 0===n?void 0:n.context});return t.currentChanged.connect(((e,t)=>{s.context=(null==t?void 0:t.context)||void 0})),s}},Ct=[{id:"jupytercad:plugin",autoStart:!0,requires:[i.ITranslator],optional:[a.IMainMenu],provides:Ze,activate:(e,t,s)=>{const i=new o.WidgetTracker({namespace:wt});Ve.worker=new Worker(new URL(n.p+n.u(647),n.b)),console.log("JupyterLab extension jupytercad is activated!");return function(e,t,n){const s=n.load("jupyterlab"),{commands:o}=e;o.addCommand(ce.redo,{label:s.__("Redo"),isEnabled:()=>Boolean(t.currentWidget),execute:e=>{const n=t.currentWidget;if(n)return n.context.model.sharedModel.redo()},icon:c.redoIcon}),o.addCommand(ce.undo,{label:s.__("Undo"),isEnabled:()=>Boolean(t.currentWidget),execute:e=>{const n=t.currentWidget;if(n)return n.context.model.sharedModel.undo()},icon:c.undoIcon}),o.addCommand(ce.newSketch,{label:s.__("New Sketch"),iconClass:"fa fa-pencil",isEnabled:()=>Boolean(t.currentWidget),execute:async e=>{const n=t.currentWidget;if(!n)return;const s={sharedModel:n.context.model.sharedModel,closeCallback:{handler:()=>{}}},o=new q(s);s.closeCallback.handler=()=>o.close(),await o.launch()}}),o.addCommand(ce.newBox,{label:s.__("New Box"),isEnabled:()=>Boolean(t.currentWidget),icon:A,execute:he.createPart("box",t)}),o.addCommand(ce.newCylinder,{label:s.__("New Cylinder"),isEnabled:()=>Boolean(t.currentWidget),icon:T,execute:he.createPart("cylinder",t)}),o.addCommand(ce.newSphere,{label:s.__("New Sphere"),isEnabled:()=>Boolean(t.currentWidget),icon:E,execute:he.createPart("sphere",t)}),o.addCommand(ce.newCone,{label:s.__("New Cone"),isEnabled:()=>Boolean(t.currentWidget),icon:O,execute:he.createPart("cone",t)}),o.addCommand(ce.newTorus,{label:s.__("New Torus"),isEnabled:()=>Boolean(t.currentWidget),icon:I,execute:he.createPart("torus",t)}),o.addCommand(ce.extrusion,{label:s.__("Extrusion"),isEnabled:()=>Boolean(t.currentWidget),icon:B,execute:he.executeOperator("extrusion",t)}),o.addCommand(ce.cut,{label:s.__("Cut"),isEnabled:()=>Boolean(t.currentWidget),icon:L,execute:he.executeOperator("cut",t)}),o.addCommand(ce.union,{label:s.__("Union"),isEnabled:()=>Boolean(t.currentWidget),icon:N,execute:he.executeOperator("union",t)}),o.addCommand(ce.intersection,{label:s.__("Intersection"),isEnabled:()=>Boolean(t.currentWidget),icon:k,execute:he.executeOperator("intersection",t)}),o.addCommand(ce.updateAxes,{label:s.__("Axes Helper"),isEnabled:()=>Boolean(t.currentWidget),icon:D,execute:async()=>{const e=t.currentWidget;if(!e)return;const n=new Q({context:e.context,title:re.title,schema:re.schema,sourceData:re.default(e.content),syncData:re.syncData(e.content),cancelButton:!0});await n.launch()}}),o.addCommand(ce.updateExplodedView,{label:s.__("Exploded View"),isEnabled:()=>Boolean(t.currentWidget),icon:F,execute:async()=>{const e=t.currentWidget;if(!e)return;const n=new Q({context:e.context,title:de.title,schema:de.schema,sourceData:de.default(e.content),syncData:de.syncData(e.content),cancelButton:!0});await n.launch()}}),o.addCommand(ce.updateCameraSettings,{label:s.__("Camera Settings"),isEnabled:()=>Boolean(t.currentWidget),iconClass:"fa fa-camera",execute:async()=>{const e=t.currentWidget;if(!e)return;const n=new Q({context:e.context,title:le.title,schema:le.schema,sourceData:le.default(e.content),syncData:le.syncData(e.content),cancelButton:!0});await n.launch()}})}(e,i,t),s&&function(e,t){e.editMenu.undoers.redo.add({id:ce.redo,isEnabled:t}),e.editMenu.undoers.undo.add({id:ce.undo,isEnabled:t})}(s,(()=>null!==i.currentWidget&&i.currentWidget===e.shell.currentWidget)),i}},{id:"jupytercad:controlpanel",autoStart:!0,requires:[s.ILayoutRestorer,Ze,Ue],activate:(e,t,n,s)=>{const o=new et({tracker:n}),i=new ht({model:o,annotationModel:s,tracker:n});i.id="jupytercad::leftControlPanel",i.title.caption="JupyterCad Control Panel",i.title.icon=S;const a=new ut({model:o});a.id="jupytercad::rightControlPanel",a.title.caption="JupyterCad Control Panel",a.title.icon=S,t&&(t.add(i,wt),t.add(a,wt)),e.shell.add(i,"left",{rank:2e3}),e.shell.add(a,"right",{rank:2e3})}},Xe,Qe,xt,_t]}}]);